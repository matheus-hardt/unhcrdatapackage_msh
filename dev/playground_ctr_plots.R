#' Playground for editing Country Plots
#'
#' This file contains the source code for all country plotting functions in unhcrdatapackage.
#' Modify the functions below to change parameters or styles.
#' Run this entire script to reload the functions and execute the tests at the bottom.

# Load required libraries
pkgload::load_all(export_all = TRUE)
library(ggplot2)
library(tidyverse)
library(scales)
library(unhcrthemes)
library(refugees)
library(testthat)
library(fontawesome)
library(ggsvg)

message("Loading customized functions...")


## Source: plot_ctr_asylum.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Asylum Applications & Decision over time
#' This charts allow to visualize trends in terms of asylum applications, decision and refugee status recognition
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param lag Number of year to used as comparison base
#' @param label_font_size Numeric value for label font size, default to 4
#' @param category_font_size Numeric value for axis text font size, default to 10
#' @param legend_font_size Numeric value for legend font size, default to 10
#' @importFrom ggplot2 ggplot aes coord_flip element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs position_stack scale_color_manual scale_colour_manual
#'             geom_text guide_axis facet_wrap vars
#'             scale_fill_manual scale_x_continuous scale_x_discrete scale_y_continuous sym theme
#' @importFrom utils head
#' @importFrom dplyr desc select case_when lag mutate group_by filter summarize ungroup
#'               pull distinct n arrange across slice left_join rename inner_join recode
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr scale_fill_unhcr_d
#' @importFrom scales pretty_breaks cut_short_scale label_number
#'
#' @return a ggplot2 object
#'
#' @export
#' @examples
#' plot_ctr_asylum(
#'   year = 2024,
#'   country_asylum_iso3c = "ECU",
#'   lag = 10,
#'   label_font_size = 4,
#'   category_font_size = 10,
#'   legend_font_size = 10
#' )
plot_ctr_asylum <- function(
  year = 2024,
  country_asylum_iso3c,
  lag = 10,
  label_font_size = 4,
  category_font_size = 10,
  legend_font_size = 10
) {
  # 1. Get Country Name
  country_name_text <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::distinct(coa_name) |>
    dplyr::pull() |>
    utils::head(1)

  # 2. Prepare Applications Data
  apps <- refugees::asylum_applications |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::group_by(year, coa_iso) |>
    dplyr::summarize(
      NumberApplications = sum(applied, na.rm = TRUE),
      .groups = "drop"
    ) |>
    dplyr::rename(CountryAsylumCode = coa_iso)

  # 3. Prepare Decisions Data (FIXED SECTION)
  decs <- refugees::asylum_decisions |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::group_by(year, coa_iso) |>
    dplyr::summarize(
      Recognized = sum(dec_recognized, na.rm = TRUE),
      ComplementaryProtection = sum(dec_other, na.rm = TRUE),
      OtherwiseClosed = sum(dec_closed, na.rm = TRUE),
      Rejected = sum(dec_rejected, na.rm = TRUE),
      TotalDecided = sum(dec_total, na.rm = TRUE),
      .groups = "drop"
    ) |>
    dplyr::rename(CountryAsylumCode = coa_iso)

  # 4. Join and Reshape
  data <- dplyr::inner_join(apps, decs, by = c("year", "CountryAsylumCode")) |>
    dplyr::filter(year >= (!!year - lag)) |> # Use !! to unquote the function argument
    dplyr::select(year, NumberApplications, Recognized, TotalDecided) |>
    tidyr::pivot_longer(
      cols = c(NumberApplications, TotalDecided, Recognized), # Explicit columns safer than ranges
      names_to = "AsylumStage",
      values_to = "Total",
      values_drop_na = TRUE
    )

  # 5. Factor Management
  data$AsylumStage <- dplyr::recode(
    data$AsylumStage,
    "NumberApplications" = "Total Number of Applications",
    "TotalDecided" = "Total Number of Decisions",
    "Recognized" = "Number of Refugee Status Recognition Decisions"
  )

  data$AsylumStage <- factor(
    data$AsylumStage,
    levels = c(
      "Total Number of Applications",
      "Total Number of Decisions",
      "Number of Refugee Status Recognition Decisions"
    )
  )

  # 6. Plotting
  p <- ggplot2::ggplot() +
    ggplot2::geom_col(
      data = data,
      ggplot2::aes(x = year, y = Total, fill = AsylumStage),
      position = "dodge",
      width = 0.8
    ) +
    unhcrthemes::scale_fill_unhcr_d(
      palette = "pal_unhcr",
      labels = scales::label_wrap(20)
    ) +
    ggplot2::guides(fill = ggplot2::guide_legend(nrow = 2, byrow = TRUE)) +
    ggplot2::scale_x_continuous(breaks = scales::breaks_width(1)) +
    ggplot2::scale_y_continuous(
      labels = scales::label_number(
        accuracy = 1,
        scale_cut = scales::cut_short_scale()
      ),
      expand = ggplot2::expansion(mult = c(0, 0.1))
    ) +
    ggplot2::labs(
      title = paste0(
        "Asylum Applications & Decisions | ",
        country_name_text,
        " ",
        (year - lag),
        " - ",
        year
      ),
      subtitle = "Note: Under certain circumstances, one person may have more than one application",
      x = "",
      y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    ) +
    unhcrthemes::theme_unhcr(
      font_size = 14,
      grid = "Y" # Standard bar charts usually look better with Y grid lines only
    ) +
    ggplot2::theme(
      panel.grid.major.y = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.x = ggplot2::element_blank(),
      legend.position = "bottom", # Usually better for long legends
      axis.text = ggplot2::element_text(size = category_font_size),
      legend.text = ggplot2::element_text(size = legend_font_size),
      legend.title = ggplot2::element_blank()
    )

  return(p)
}


## Source: plot_ctr_destination.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Main Destination from  one specific countr
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_origin_iso3c Character value with the ISO-3 character code of the Country of Origin
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#'
#' @param label_font_size Numeric value for label font size, default to 4
#' @param category_font_size Numeric value for axis text font size, default to 10
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text theme_void
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr unhcr_pal
#'
#' @return a ggplot2 object
#'
#' @export
#'
#' @examples
#' #
#' plot_ctr_destination(
#'   year = 2024,
#'   country_origin_iso3c = "COL",
#'   pop_type = c("REF", "ASY"),
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
plot_ctr_destination <- function(
  year = 2024,
  country_origin_iso3c,
  pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC"),
  label_font_size = 4,
  category_font_size = 10
) {
  dict_pop_type_label <- c(
    "refugees" = "REF",
    "returned_refugees" = "RETURNED_REF",
    "asylum_seekers" = "ASY",
    "idps" = "IDP",
    "returned_idps" = "RETURNED_IDP",
    "oip" = "OIP",
    "stateless" = "STA",
    "ooc" = "OOC",
    "hst" = "HST"
  )
  country_name_text <- refugees::population |>
    dplyr::filter(coo_iso == country_origin_iso3c) |>
    dplyr::distinct(coo_name) |>
    dplyr::pull() |>
    head(1)

  Destination <- refugees::population |>
    dplyr::filter(
      coo_iso == country_origin_iso3c,
      year == year
    ) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "Population.type",
      values_to = "value"
    ) |>
    dplyr::mutate(
      Population.type = stringr::str_replace_all(
        Population.type,
        pattern = dict_pop_type_label
      )
    ) |>
    dplyr::filter(Population.type %in% as.vector(pop_type)) |>
    dplyr::rename(CountryAsylumName = coa_name) |>
    dplyr::mutate(
      CountryAsylumName = str_replace(
        CountryAsylumName,
        " \\(Bolivarian Republic of\\)",
        ""
      ),
      CountryAsylumName = str_replace(
        CountryAsylumName,
        "Iran \\(Islamic Republic of\\)",
        "Iran"
      ),
      CountryAsylumName = str_replace(
        CountryAsylumName,
        "United States of America",
        "USA"
      ),
      CountryAsylumName = str_replace(
        CountryAsylumName,
        "United Kingdom of Great Britain and Northern Ireland",
        "UK"
      )
    ) |>
    group_by(CountryAsylumName) |>
    summarise(DisplacedAcrossBorders = sum(value, na.rm = TRUE)) |>
    mutate(
      DisplacedAcrossBordersRound = ifelse(
        DisplacedAcrossBorders > 1000,
        paste(
          scales::label_number(
            accuracy = .1,
            scale_cut = scales::cut_short_scale()
          )(DisplacedAcrossBorders)
        ),
        as.character(DisplacedAcrossBorders)
      )
    ) |>
    arrange(desc(DisplacedAcrossBorders)) |>
    head(10) |>
    filter(DisplacedAcrossBorders > 0)

  if (nrow(Destination) == 0) {
    info <- paste0(
      "There's no recorded Countries of destination \n in ",
      country_name_text,
      " for ",
      year
    )
    p <- ggplot() +
      annotate(
        stringr::str_wrap("text", 80),
        x = 1,
        y = 1,
        size = 11,
        label = info
      ) +
      theme_void()
  } else {
    # Make plot
    p <- ggplot() +
      geom_col(
        data = Destination,
        aes(
          x = reorder(CountryAsylumName, DisplacedAcrossBorders),
          ## Reordering country by value
          y = DisplacedAcrossBorders
        ),
        fill = unhcrthemes::unhcr_pal(n = 1, "pal_blue")
      ) + # here we configure that it will be bar chart+
      ## Format axis number
      scale_y_continuous(
        expand = expansion(c(0, 0.1)),
        labels = scales::label_number(scale_cut = scales::cut_short_scale())
      ) +
      ## Position label differently in the bar in white - outside bar in black
      geom_text(
        data = subset(
          Destination,
          DisplacedAcrossBorders < max(DisplacedAcrossBorders) / 1.5
        ),
        aes(
          x = reorder(CountryAsylumName, DisplacedAcrossBorders),
          y = DisplacedAcrossBorders,
          label = DisplacedAcrossBordersRound
        ),
        hjust = -0.1,
        vjust = 0.5,
        colour = "black",
        size = label_font_size
      ) +
      geom_text(
        data = subset(
          Destination,
          DisplacedAcrossBorders >= max(DisplacedAcrossBorders) / 1.5
        ),
        aes(
          x = reorder(CountryAsylumName, DisplacedAcrossBorders),
          y = DisplacedAcrossBorders,
          label = DisplacedAcrossBordersRound
        ),
        hjust = 1.1,
        vjust = 0.5,
        colour = "white",
        size = label_font_size
      ) +
      # Add `coord_flip()` to make your vertical bars horizontal:
      coord_flip() +

      ## and the chart labels
      labs(
        title = paste0(
          "What are the main destinations for Forcibly Displaced People?"
        ),
        subtitle = paste0(
          "Top Destination Countries | as of ",
          year,
          " for population from ",
          country_name_text
        ),
        x = "",
        y = "",
        caption = "Source: UNHCR Population Statistics Database.\n Forced Displacement includes Refugees, Asylum-seekers and Other in Need of International Protection."
      ) +
      ggplot2::scale_x_discrete(labels = scales::label_wrap(45)) +
      theme_unhcr(
        font_size = 14,
        grid = FALSE,
        axis = "y",
        axis_title = FALSE,
        axis_text = "y"
      ) +
      ggplot2::theme(
        axis.text.y = ggplot2::element_text(size = category_font_size),
        plot.margin = ggplot2::margin(5, 5, 5, 30)
      )
  }
  return(p) # print(p)
}


## Source: plot_ctr_diff_in_pop_groups.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Increases and Decreases in Population Groups
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#'
#' @param label_font_size Numeric value for label font size, default to 4
#' @param category_font_size Numeric value for axis text font size, default to 10
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer  gather separate spread
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#'
#' @examples
#' #
#' plot_ctr_diff_in_pop_groups(
#'   year = 2024,
#'   country_asylum_iso3c = "ROU",
#'   pop_type = c("REF", "ASY"),
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
plot_ctr_diff_in_pop_groups <- function(
  year = 2024,
  country_asylum_iso3c,
  pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC"),
  label_font_size = 4,
  category_font_size = 10
) {
  country_name_text <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::distinct(coa_name) |>
    dplyr::pull() |>
    head(1)

  pop_data <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::filter(year %in% c(year, year - 1)) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(
      population_type = dplyr::case_when(
        population_type == "refugees" ~ "REF",
        population_type == "asylum_seekers" ~ "ASY",
        population_type == "idps" ~ "IDP",
        population_type == "oip" ~ "OIP",
        population_type == "stateless" ~ "STA",
        population_type == "ooc" ~ "OOC",
        TRUE ~ population_type
      )
    ) |>
    dplyr::group_by(year, population_type) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE)) |>
    dplyr::ungroup()

  df <- pop_data |>
    tidyr::pivot_wider(
      names_from = year,
      values_from = value,
      names_prefix = "year_"
    ) |>
    dplyr::mutate(
      diffabs = .data[[paste0("year_", year)]] -
        .data[[paste0("year_", year - 1)]],
      diffper = (.data[[paste0("year_", year)]] -
        .data[[paste0("year_", year - 1)]]) /
        .data[[paste0("year_", year - 1)]]
    ) |>
    dplyr::mutate(
      diffper = scales::label_percent(accuracy = 1, trim = FALSE)(diffper)
    ) |>
    dplyr::filter(population_type %in% pop_type)

  p <- ggplot() +
    geom_col(
      data = df,
      aes(
        x = population_type,
        y = diffabs,
        fill = population_type
      ),
      width = 0.8
    ) +
    scale_fill_manual(
      values = c(
        "ASY" = "#6CD8FD",
        "REF" = "#0072BC",
        "OIP" = "#D25A45",
        # "VDA" = "#EF4A60",
        "OOC" = "#bfbfbf",
        "IDP" = "#32C189",
        "STA" = "#FFC740"
      ),
      drop = TRUE,
      limits = force,
      guide = "none"
    ) +
    scale_y_continuous(expand = expansion(mult = c(0.15, 0.15))) +
    scale_x_discrete(
      labels = c(
        "ASY" = "Asylum-seekers",
        "REF" = "Refugees",
        # "VDA" = "Venezuelans Displaced\nAbroad", ,
        "OIP" = "Other people in need\n of international protection",
        "OOC" = "Others of Concern\nto UNHCR",
        "IDP" = "Internally Displaced\nPersons",
        "STA" = "Stateless Persons"
      ),
      drop = TRUE,
      limits = force
    ) +

    ## Adding labels with conditionned positions...

    geom_text(
      data = subset(df, diffabs >= 0 & diffabs < max(diffabs) / 1.5),
      aes(
        x = population_type,
        y = diffabs,
        label = label_number(
          accuracy = 1,
          scale_cut = cut_short_scale()
        )(diffabs)
      ),
      vjust = -0.5,
      colour = "black",
      size = label_font_size
    ) +
    geom_text(
      data = subset(df, diffabs >= 0 & diffabs < max(diffabs) / 1.5),
      aes(
        x = population_type,
        y = diffabs,
        label = paste("\u2191", diffper)
      ),
      vjust = -2.0,
      colour = "black",
      size = label_font_size
    ) +
    geom_text(
      data = subset(df, diffabs >= 0 & diffabs >= max(diffabs) / 1.5),
      aes(
        x = population_type,
        y = diffabs,
        label = label_number(
          accuracy = 1,
          scale_cut = cut_short_scale()
        )(diffabs)
      ),
      vjust = 2.7,
      colour = "white",
      size = label_font_size
    ) +
    geom_text(
      data = subset(df, diffabs >= 0 & diffabs >= max(diffabs) / 1.5),
      aes(
        x = population_type,
        y = diffabs,
        label = paste("\u2191", diffper)
      ),
      vjust = 1.2,
      colour = "white",
      size = label_font_size
    ) +
    geom_text(
      data = subset(df, diffabs < 0 / 1.5),
      aes(
        x = population_type,
        y = diffabs,
        label = label_number(
          accuracy = 1,
          scale_cut = cut_short_scale()
        )(diffabs)
      ),
      vjust = 1.2,
      colour = "black",
      size = label_font_size
    ) +
    geom_text(
      data = subset(df, diffabs < 0 / 1.5),
      aes(
        x = population_type,
        y = diffabs,
        label = paste("\u2193", diffper)
      ),
      vjust = 2.7,
      colour = "black",
      size = label_font_size
    ) +
    geom_hline(yintercept = 0, color = "black") +
    labs(
      title = paste0(
        country_name_text,
        ": Increases and Decreases in Population Groups | ",
        year - 1,
        "-",
        year
      ),
      subtitle = "Number of people and percentage",
      caption = "Source: UNHCR.org/refugee-statistics"
    ) +
    theme_unhcr(
      grid = FALSE,
      axis = "x",
      axis_title = FALSE,
      axis_text = "x",
      font_size = 14
    ) +
    theme(
      axis.line.x = element_line(color = "white"),
      axis.text.x = element_text(size = category_font_size),
      legend.title = element_blank()
    )

  # geom_text(
  #   data = subset(df, diffabs < 0 & diffabs <= min(diffabs) / 1.5),
  #   aes(
  #     x = population_type,
  #     y = diffabs,
  #     label = label_number(accuracy = 1,
  #                                  scale_cut = cut_short_scale())(diffabs)
  #   ),
  #   vjust = -2.0 ,
  #   colour = "white",
  #   size = 5
  # )  +
  #   geom_text(
  #     data = subset(df, diffabs < 0 & diffabs <= min(diffabs) / 1.5),
  #     aes(
  #       x = population_type,
  #       y = diffabs,
  #       label = diffper
  #     ),
  #     vjust = -0.5 ,
  #     colour = "white",
  #     size = 5
  #   ) +

  return(p) # print(p)
}


## Source: plot_ctr_disp_migrant.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

# #' Plotting ratio Refugee/Asylum-seekers vs Migrant within a country
# #'
# #' This chart provides insights on the relative weight of Forced Displacement for countries generating such type of displacement.
# #' First, the size of the circle represents the number of Refugees, Asylum-seekers and other in need of International Protection
# #' The vertical axis represent the Share of immigrants from the country in relation with all immigrants within the country.
# #' The higher is country in this axis, the more people from this country are the host country independently of the reason why they migrated.
# #' The horizontal axis displays the share of migration generated by forced displacement within each country of origin.
# #' The more a country is right, the more people from that country cam because of Forced Displacement.
# #'
# #'
# #' @param year Numeric value of the year (for instance 2020)
# #' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
# #' @param top_n_countries Numeric value of number of main countries that the graph should display
# #'
# #' @param label_font_size Numeric value for label font size, default to 4
# #' @param category_font_size Numeric value for axis text font size, default to 10
# #'
# #' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
# #'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
# #'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
# #'             geom_text geom_point scale_size coord_cartesian theme_void
# #'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
# #' @importFrom utils  head
# #' @importFrom tidyselect where
# #' @importFrom stringr  str_replace
# #' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
# #' @importFrom stats  reorder aggregate
# #' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
# #'               pull distinct n arrange across slice left_join across
# #' @importFrom tidyr pivot_longer
# #' @importFrom unhcrthemes theme_unhcr
# #' @importFrom viridis scale_fill_viridis
# #' @import ForcedDisplacementStat
# #'
# #' @return a ggplot2 object
# #'
# #' @export
# #'
# #' @examples

#' Summary Key Figures
#'  Key figures can be highlighted with humanitarian icons
#'   https://fontawesome.com/icons/categories/humanitarian
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @return ggplot2
#'
#' @importFrom dplyr desc select case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom ggplot2 ggplot geom_text scale_color_manual xlim ylim facet_wrap labs theme_void theme element_text aes vars
#' @importFrom tidyr pivot_longer
#' @importFrom refugees population
#'
#' @export
#' @examples
#' plot_ctr_keyfig(
#'   year = 2024,
#'   country_asylum_iso3c = "COL"
#' )
plot_ctr_keyfig <- function(
  year = 2024,
  country_asylum_iso3c,
  label_font_size = 4,
  category_font_size = 10
) {
  # Get country name
  country_name_text <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::slice(1) |>
    dplyr::pull(coa_name)

  # Calculate Total POC for current year
  total_poc <- refugees::population |>
    dplyr::filter(
      year == !!year,
      coa_iso == country_asylum_iso3c
    ) |>
    dplyr::summarise(
      total = sum(
        refugees,
        asylum_seekers,
        idps,
        oip,
        stateless,
        ooc,
        hst,
        na.rm = TRUE
      )
    ) |>
    dplyr::pull()

  # Calculate Total POC for previous year
  total_poc_prev <- refugees::population |>
    dplyr::filter(
      year == (!!year - 1),
      coa_iso == country_asylum_iso3c
    ) |>
    dplyr::summarise(
      total = sum(
        refugees,
        asylum_seekers,
        idps,
        oip,
        stateless,
        ooc,
        hst,
        na.rm = TRUE
      )
    ) |>
    dplyr::pull()

  # Calculate percentage change
  perc_change_poc <- (total_poc - total_poc_prev) / total_poc_prev * 100

  # Define specific colors
  cols <- c(
    "Internally displaced\npersons" = "#32C189",
    "Other people in need\nof international protection" = "#D25A45",
    "Asylum-seekers" = "#6CD8FD",
    "Refugees" = "#0072BC",
    "Others of concern\nto UNHCR" = "#bfbfbf",
    "Stateless people" = "#FFC740",
    "Host community" = "#000000",
    "Other" = "#000000"
  )

  # Define icon mapping
  icon_map <- c(
    "refugees" = "person-walking-luggage",
    "asylum_seekers" = "scale-balanced",
    "idps" = "house-chimney-crack",
    "oip" = "hand-holding-heart",
    "stateless" = "globe",
    "ooc" = "users",
    "hst" = "handshake"
  )

  # Prepare data for plotting
  keyfig <- refugees::population |>
    dplyr::filter(
      year == !!year,
      coa_iso == country_asylum_iso3c
    ) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::group_by(population_type) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE)) |>
    dplyr::mutate(
      population_type_label = dplyr::case_when(
        population_type == "refugees" ~ "Refugees",
        population_type == "asylum_seekers" ~ "Asylum-seekers",
        population_type == "idps" ~ "Internally displaced\npersons",
        population_type ==
          "oip" ~ "Other people in need\nof international protection",
        population_type == "stateless" ~ "Stateless people",
        population_type == "ooc" ~ "Others of concern\nto UNHCR",
        population_type == "hst" ~ "Host community",
        TRUE ~ "Other"
      )
    ) |>
    dplyr::filter(value > 0) |>
    dplyr::rowwise() |>
    dplyr::mutate(
      label = paste0(
        format(round(value, 0), big.mark = ","),
        " ",
        population_type_label
      ),
      # Use specific color if available, else gray
      color_hex = ifelse(
        population_type_label %in% names(cols),
        cols[population_type_label],
        "#333333"
      ),
      # Map icon name, fallback to circle-question
      icon_name = ifelse(
        population_type %in% names(icon_map),
        icon_map[population_type],
        "circle-question"
      ),
      # Generate SVG string with correct fill color
      svg_text = as.character(fontawesome::fa(icon_name, fill = color_hex))
    ) |>
    dplyr::ungroup()

  # Plotting
  p <- ggplot2::ggplot(keyfig) +
    # LAYER 1: ICONS using ggsvg
    ggsvg::geom_point_svg(
      ggplot2::aes(
        x = 0.5,
        y = 1.8,
        svg = svg_text
      ),
      size = 10
    ) +
    # LAYER 2: LABELS
    ggplot2::geom_text(
      ggplot2::aes(
        x = 0.5,
        y = 0.8,
        label = label,
        color = population_type_label
      ),
      family = "Lato",
      size = label_font_size,
      fontface = "bold"
    ) +
    ggplot2::scale_color_manual(values = cols) +
    ggplot2::xlim(c(0, 1)) +
    ggplot2::ylim(c(0, 3)) +
    ggplot2::facet_wrap(ggplot2::vars(population_type_label), ncol = 2) +
    ggplot2::labs(
      title = paste0("Key Figures for ", country_name_text, " as of ", year),
      subtitle = paste0(
        "A total of ",
        format(round(total_poc, 0), scientific = FALSE, big.mark = ","),
        " people, ",
        ifelse(perc_change_poc > 0, "increasing", "decreasing"),
        " by ",
        round(abs(perc_change_poc), 1),
        "% compared to the previous year"
      ),
      caption = "Source: UNHCR.org refugee-statistics"
    ) +
    ggplot2::theme_void() +
    ggplot2::theme(
      strip.text = ggplot2::element_blank(),
      legend.position = "none",
      plot.title = ggplot2::element_text(
        family = "Lato",
        face = "bold",
        size = 18,
        hjust = 0.5
      ),
      plot.subtitle = ggplot2::element_text(
        family = "Lato",
        size = 12,
        hjust = 0.5,
        margin = ggplot2::margin(b = 20)
      )
    )

  return(p)
}


## Source: plot_ctr_location.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Create a map with symbol proportional to population data by location within country
#'
#' @param year Numeric value of the year  (for instance 2022).
#'             If the data is not yet available for that year (aka still in the mid year reporting stage),
#'              it will automatically fall back on the previous year
#'
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' @param  mapbackground can be "osm" (default), "stamen-toner" , "stamen-terrain","stamen-watercolor".
#'            Other mapbackground requires an API key and were not considered
#'
#' @param label_font_size Numeric value for label font size, default to 4
#' #' @param category_font_size Numeric value for axis text font size, default to 10
#' #'
#' #' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#' #'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#' #'             geom_label geom_text labs  position_stack  geom_point
#' #'             scale_color_manual scale_colour_manual
#' #'             scale_size_continuous element_rect
#' #'             geom_text .pt theme_void
#' #'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' #' @importFrom utils  head
#' #' @importFrom tidyselect where
#' #' @importFrom stringr  str_replace str_detect  str_glue
#' #' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' #' @importFrom stats  reorder aggregate  setNames
#' #' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#' #'               pull distinct n arrange across slice left_join
#' #' @importFrom tidyr pivot_longer pivot_wider
#' #' @importFrom ggspatial geom_sf coord_sf
#' #' @importFrom sf st_as_sf st_set_crs st_bbox
#' #' @importFrom rnaturalearth ne_countries
#' #' @import rnaturalearthdata
#' #' @importFrom ggrepel geom_label_repel
#' #' @importFrom grDevices hcl.colors
#' #' @importFrom OpenStreetMap openmap openproj autoplot.OpenStreetMap
#' #' @importFrom unhcrthemes theme_unhcr
#' #'
#' #' @return a ggplot2 object
#' #'
#' #' @export
#' #'
#' #' @examples
#' #' # plot_ctr_location(year = 2024,
#' #' #                  country_asylum_iso3c = "COL",
#' #' #                  pop_type = c("ASY", "REF", "OIP"))
#' #' #
#' #' # plot_ctr_location(year = 2024,
#' #' #                  country_asylum_iso3c = "COL",
#' #' #                  pop_type = c("IDP"))
#' #' #
#' #' # plot_ctr_location(year = 2024,
#' #' #                  country_asylum_iso3c = "CAN",
#' #' #                  pop_type = c("ASY", "REF", "OIP"))
#' #' #
#' #' # plot_ctr_location(year = 2024,
#' #' #                  country_asylum_iso3c = "MEX",
#' #' #                  pop_type = c("ASY", "REF", "OIP"),
#' #' #                  label_font_size = 4,
#' #' #                  category_font_size = 10)
plot_ctr_location <- function(
  year,
  country_origin_iso3c,
  pop_type,
  mapbackground = "osm",
  label_font_size = 4,
  category_font_size = 10
) {
  # Get country name for Origin
  country_name_text <- refugees::population |>
    dplyr::filter(coo_iso == country_origin_iso3c) |>
    dplyr::distinct(coo_name) |>
    dplyr::pull() |>
    head(1)

  if (length(country_name_text) == 0) {
    country_name_text <- country_origin_iso3c
  }

  dict_pop_type_name <- c(
    "REF" = "Refugees",
    "RETURNED_REF" = "Returnees",
    "ASY" = "Asylum-seekers",
    "IDP" = "Internally displaced persons",
    "RETURNED_IDP" = "Returned idps",
    "OIP" = "Other people in need of international protection",
    "STA" = "Stateless people",
    "OOC" = "Others of concern to UNHCR",
    "HST" = "Host community"
  )

  # Prepare Data: Filter by Origin and summarize by Asylum
  data <- refugees::population |>
    dplyr::filter(
      year == !!year,
      coo_iso == country_origin_iso3c
    ) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(
      population_type = dplyr::case_when(
        population_type == "refugees" ~ "REF",
        population_type == "asylum_seekers" ~ "ASY",
        population_type == "idps" ~ "IDP",
        population_type == "oip" ~ "OIP",
        population_type == "stateless" ~ "STA",
        population_type == "ooc" ~ "OOC",
        population_type == "hst" ~ "HST",
        TRUE ~ population_type
      )
    ) |>
    dplyr::filter(population_type %in% pop_type) |>
    dplyr::group_by(coa_iso) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE)) |>
    dplyr::ungroup()

  # Get World Map
  world_sf <- rnaturalearth::ne_countries(
    scale = "medium",
    returnclass = "sf"
  ) |>
    dplyr::filter(iso_a3 != "ATA") |> # Exclude Antarctica for better view
    sf::st_make_valid()

  # Join Data to Map
  map_data <- world_sf |>
    dplyr::left_join(data, by = c("iso_a3" = "coa_iso"))

  # Plot
  p <- ggplot2::ggplot() +
    ggplot2::geom_sf(
      data = map_data,
      ggplot2::aes(fill = value),
      color = "white",
      size = 0.1
    ) +
    # Highlight Origin Country
    ggplot2::geom_sf(
      data = world_sf |> dplyr::filter(iso_a3 == country_origin_iso3c),
      fill = "#333333", # Dark grey for origin
      color = "white",
      size = 0.2
    ) +
    ggplot2::coord_sf(
      crs = "+proj=robin",
      datum = NA
    ) +
    ggplot2::scale_fill_gradient(
      low = "#DCE9FF", # Lightest UNHCR Blue
      high = "#0072BC", # UNHCR Blue
      na.value = "#F0F0F0", # Light grey for no data
      name = "Population",
      labels = scales::label_comma()
    ) +
    ggplot2::labs(
      title = paste0(
        "Where are people from ",
        country_name_text,
        "?"
      ),
      subtitle = paste0(
        "Destination countries of ",
        paste(dict_pop_type_name[pop_type], collapse = ", "),
        " from ",
        country_name_text,
        " as of ",
        year
      ),
      caption = "Source: UNHCR.org/refugee-statistics.\nOrigin country highlighted in dark grey.",
      x = NULL,
      y = NULL
    ) +
    unhcrthemes::theme_unhcr(
      font_size = 14,
      grid = FALSE,
      axis = FALSE
    ) +
    ggplot2::theme(
      legend.key.width = ggplot2::unit(2, "cm"),
      legend.key.height = ggplot2::unit(0.5, "cm"),
      legend.text = ggplot2::element_text(size = 10),
      axis.text = ggplot2::element_blank(),
      axis.title = ggplot2::element_blank(),
      panel.grid = ggplot2::element_blank()
    )

  return(p)
}


## Source: plot_ctr_origin_history.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Plot Origin History
#'
#' The functions gives a quick overview of the main source of displacement in terms of origin in the country
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param lag Number of year to used as comparison base
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OIP, OOC, STA)
#' @param otherprop value set by default to .02 - used to merge origin as "Other"
#'
#' #' @param category_font_size Numeric value for axis text font size, default to 10
#' #' @param legend_font_size Numeric value for legend font size, default to 10
#' #'
#' #' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#' #'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#' #'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#' #'             geom_text scale_fill_brewer scale_colour_brewer
#' #'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' #' @importFrom utils  head
#' #' @importFrom tidyselect where
#' #' @importFrom stringr  str_replace
#' #' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' #' @importFrom stats  reorder aggregate
#' #' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#' #'               pull distinct n arrange across slice left_join
#' #' @importFrom ggalluvial geom_alluvium
#' #' @importFrom unhcrthemes theme_unhcr
#' #'
#' #' @return a ggplot2 object
#' #'
#' #' @export
#' #' @examples
#' #' plot_ctr_origin_history(
#' #'     year = 2024,
#' #'     lag = 5,
#' #'     country_asylum_iso3c = "MEX",
#' #'     pop_type = c(
#' #'         "REF",
#' #'         "ASY",
#' #'         "OIP",
#' #'         "IDP"
#' #'     ),
#' #'     otherprop = .02,
#' #'     category_font_size = 10,
#' #'     legend_font_size = 10
#' #' )
plot_ctr_origin_history <- function(
  year = 2024,
  lag = 5,
  country_asylum_iso3c,
  pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC"),
  otherprop = .02,
  category_font_size = 10,
  legend_font_size = 10
) {
  dict_pop_type_name <- c(
    "refugees" = "Refugees",
    "returned_refugees" = "Returned refugees",
    "asylum_seekers" = "Asylum-seekers",
    "idps" = "Internally displaced persons",
    "returned_idps" = "Returned idps",
    "oip" = "Other people in need of international protection",
    "stateless" = "Stateless people",
    "ooc" = "Others of concern to UNHCR",
    "hst" = "Host community"
  )

  dict_pop_type_label <- c(
    "refugees" = "REF",
    "returned_refugees" = "RETURNED_REF",
    "asylum_seekers" = "ASY",
    "idps" = "IDP",
    "returned_idps" = "RETURNED_IDP",
    "oip" = "OIP",
    "stateless" = "STA",
    "ooc" = "OOC",
    "hst" = "HST"
  )
  df <- refugees::population |>
    dplyr::filter(
      year >= (!!year - lag), #### Parameter
      coa_iso == country_asylum_iso3c #### Parameter
    ) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "Population.type",
      values_to = "value"
    ) |>
    dplyr::mutate(
      Population.type = stringr::str_replace_all(
        Population.type,
        pattern = dict_pop_type_label
      )
    ) |>
    dplyr::filter(Population.type %in% pop_type) |>
    dplyr::rename(
      CountryAsylumName = coa_name,
      CountryOriginName = coo_name
    ) |>
    dplyr::mutate(
      value = tidyr::replace_na(value, 0),
      CountryOriginName = forcats::fct_lump_prop(
        CountryOriginName,
        prop = otherprop,
        w = value
      )
    ) |>
    group_by(year, CountryAsylumName, CountryOriginName) |>
    summarise(value = sum(value, na.rm = TRUE)) |>
    ungroup()

  country_name_text <- df |>
    distinct(CountryAsylumName) |>
    pull()

  year_breaks <- diff(range(df$year)) + 1

  # Generate Palette
  # 1. Get unique levels of CountryOriginName from the data
  #    Ensure they match the factor levels (if it is a factor) or unique values
  origin_levels <- levels(df$CountryOriginName)
  if (is.null(origin_levels)) {
    origin_levels <- unique(df$CountryOriginName)
  }

  # 2. Generate generic palette
  # Use a qualitative palette from unhcrthemes, e.g. "pal_unhcr" (primary) or "pal_unhcr_qual" (if available/preferred)
  # Falling back to "pal_unhcr" or manually picking colors
  poly_cols <- unhcrthemes::unhcr_pal(n = length(origin_levels), "pal_unhcr")

  # 3. Name the vector
  names(poly_cols) <- origin_levels

  # 4. Overwrite "Other" if present
  if ("Other" %in% names(poly_cols)) {
    poly_cols["Other"] <- "#999999" # Grey
  }

  p <- ggplot() +
    ggalluvial::geom_alluvium(
      data = df,
      aes(
        x = year,
        y = value,
        alluvium = CountryOriginName,
        fill = CountryOriginName,
        colour = CountryOriginName
      ),
      alpha = .75,
      decreasing = FALSE
    ) +
    scale_x_continuous(breaks = scales::breaks_width(1)) +
    scale_y_continuous(
      expand = expansion(c(0, 0.1)),
      labels = scales::label_number(scale_cut = scales::cut_short_scale())
    ) +
    theme_unhcr(
      grid = "Y",
      axis = "x",
      axis_title = TRUE, # axis_text = "x",
      font_size = 14
    ) +
    theme(
      axis.text.x = element_text(
        angle = -30,
        hjust = 0,
        size = category_font_size
      ),
      legend.text = element_text(size = legend_font_size),
      legend.title = element_blank()
    ) +
    scale_fill_manual(
      values = poly_cols,
      labels = scales::label_wrap(20)
    ) +
    scale_colour_manual(
      values = poly_cols,
      labels = scales::label_wrap(20)
    ) +
    ggplot2::guides(
      fill = ggplot2::guide_legend(nrow = 2, byrow = TRUE),
      colour = ggplot2::guide_legend(nrow = 2, byrow = TRUE)
    ) +
    # facet_wrap(~ region, scales = "fixed") ++
    labs(
      title = paste0(
        country_name_text,
        ":  Evolution of Forcibly Displaced Population Origin"
      ),
      subtitle = "Number of people (thousand)",
      x = "",
      y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    ) +
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 0, hjust = 0.5))

  return(p) # print(p)
}


## Source: plot_ctr_origin_recognition.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Display A Chart with Refugee Recognition Rate for nationals from a specific country
#'
#' In the absence of an internationally agreed methodology for calculating recognition rates,
#'  UNHCR uses two rates to compute the proportion of refugee claims accepted during the year:
#'
#'   * The Refugee Recognition Rate divides the number of asylum-seekers granted Convention refugee
#'   status by the total number of accepted (Convention and, where relevant, complementary
#'   protection) and rejected cases (aka substantive decision).
#'
#'   * The Total Recognition Rate divides the number of asylum-seekers granted Convention
#'    refugee status and / or complementary form of protection by the total number
#'    of accepted (Convention and, where relevant, complementary protection) and
#'     rejected cases.
#'
#' Non-substantive decisions are, to the extent possible, excluded from both
#' calculations. For the purpose of international comparability,  UNHCR only
#' uses these two recognition rates and does not report nationally calculated rates.
#'
#'      See https://www.unhcr.org/4ce531e09.pdf
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_origin_iso3c Character value with the ISO-3 character code of the Country of Origin
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' @param measure this can be either:
#'            * RefugeeRecognitionRate
#'            * TotalRecognitionRate
#' @param order_by this can be either:
#'            * Recognized
#'            * ComplementaryProtection
#'            * TotalDecided
#'
#' @param label_font_size Numeric value for label font size, default to 4
#' #' @param category_font_size Numeric value for axis text font size, default to 10
#' #'
#' #' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#' #'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#' #'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#' #'             geom_text guide_axis facet_wrap vars
#' #'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' #' @importFrom utils  head
#' #' @importFrom tidyselect where
#' #' @importFrom stringr  str_replace
#' #' @importFrom scales cut_short_scale label_percent label_number breaks_pretty pretty_breaks
#' #' @importFrom stats  reorder aggregate
#' #' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#' #'               pull distinct n arrange across slice left_join
#' #' @importFrom tidyr pivot_longer
#' #' @importFrom unhcrthemes theme_unhcr  scale_fill_unhcr_d
#' #'
#' #' @return a ggplot2 object
#' #'
#' #' @export
#' #' @examples
#' #' plot_ctr_origin_recognition(
#' #'     year = 2024,
#' #'     country_origin_iso3c = "VEN",
#' #'     top_n_countries = 10,
#' #'     measure = "RefugeeRecognitionRate",
#' #'     order_by = "TotalDecided",
#' #'     label_font_size = 4,
#' #'     category_font_size = 10
#' #' )
plot_ctr_origin_recognition <- function(
  year = 2024,
  country_origin_iso3c,
  top_n_countries = 10,
  measure = "RefugeeRecognitionRate",
  order_by = "TotalDecided",
  label_font_size = 4,
  category_font_size = 10
) {
  country_name_text <- refugees::population |>
    dplyr::filter(coo_iso == country_origin_iso3c) |>
    dplyr::distinct(coo_name) |>
    dplyr::pull() |>
    head(1)

  measurelabel <-
    dplyr::case_when(
      measure == "RefugeeRecognitionRate" ~ "Refugee Recognition Rate",
      measure == "TotalRecognitionRate" ~ "Total Recognition Rate"
    )

  order_bylabel <-
    dplyr::case_when(
      order_by == "Recognized" ~ "Recognized Refugee Status Decisions",
      order_by ==
        "ComplementaryProtection" ~ "Complementary Protection Decisions",
      order_by ==
        "TotalDecided" ~ "Total Decision (independently of the outcome)"
    )

  topAsylum <- refugees::asylum_decisions |>
    dplyr::filter(coo_iso == country_origin_iso3c & year == year) |>
    dplyr::mutate(DecisionsAveragePersonsPerCase = 1) |>
    dplyr::rename(CountryAsylumName = coa_name) |>
    dplyr::group_by(CountryAsylumName) |>
    dplyr::summarize(
      Recognized = sum(dec_recognized, na.rm = TRUE),
      ComplementaryProtection = sum(dec_other, na.rm = TRUE),
      TotalDecided = sum(dec_total, na.rm = TRUE)
    ) |>
    dplyr::mutate(
      RefugeeRecognitionRate = (Recognized) / TotalDecided,
      TotalRecognitionRate = (Recognized + ComplementaryProtection) /
        TotalDecided
    )

  topAsylum1 <- topAsylum |>
    dplyr::mutate(measured = .data[[measure]]) |>
    dplyr::mutate(order_by = .data[[order_by]]) |>
    dplyr::arrange(dplyr::desc(order_by)) |>
    head(top_n_countries) |>
    dplyr::mutate(
      measuredRound = scales::label_percent(accuracy = 0.1, suffix = "%")(
        measured
      )
    )

  rsdAsylum <- ggplot2::ggplot() +
    ggplot2::geom_col(
      data = topAsylum1,
      ggplot2::aes(
        y = measured,
        x = stats::reorder(CountryAsylumName, measured)
      ),
      fill = unhcrthemes::unhcr_pal(n = 1, "pal_blue")
    ) +
    ## Position label differently in the bar in white - outside bar in black
    ggplot2::geom_text(
      data = subset(
        topAsylum1,
        measured < max(measured) / 1.5
      ),
      ggplot2::aes(
        y = measured,
        x = stats::reorder(CountryAsylumName, measured),
        label = measuredRound
      ),
      hjust = -0.1,
      vjust = 0.5,
      colour = "black",
      size = label_font_size
    ) +
    ggplot2::geom_text(
      data = subset(
        topAsylum1,
        measured >= max(measured) / 1.5
      ),
      ggplot2::aes(
        y = measured,
        x = stats::reorder(CountryAsylumName, measured),
        label = measuredRound
      ),
      hjust = 1.1,
      vjust = 0.5,
      colour = "white",
      size = label_font_size
    ) +
    ggplot2::coord_flip() +
    ggplot2::scale_y_continuous(
      expand = ggplot2::expansion(c(0, 0.1)),
      labels = scales::label_percent(accuracy = 0.1, suffix = "%")
    ) +
    ggplot2::labs(
      title = paste0(
        measurelabel,
        " | ",
        year,
        " for Nationals from ",
        country_name_text
      ),
      subtitle = paste0(
        "For top ",
        top_n_countries,
        " Countries of Asylum ordered by ",
        order_bylabel
      ),
      x = "",
      y = "",
      caption = "Source: UNHCR.org/refugee-statistics "
    ) +
    ggplot2::scale_x_discrete(labels = scales::label_wrap(20)) +
    unhcrthemes::theme_unhcr(
      font_size = 14,
      grid = FALSE,
      axis = "y",
      axis_title = FALSE,
      axis_text = "y"
    ) +
    ggplot2::theme(
      axis.text.y = ggplot2::element_text(size = category_font_size),
      panel.grid.major.y = ggplot2::element_blank(),
      plot.margin = ggplot2::margin(5, 5, 5, 30)
    )

  return(rsdAsylum)
}


## Source: plot_ctr_population_type_abs.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Main country of origin - Absolute value
#'
#' @param year Numeric value of the year (for instance 2020)
#'
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#'
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#'
#' @param pop_type Character value. Possible population type (e.g.: REF, IDP, ASY,   OIP, OOC, STA)
#'
#' @param show_diff_label logical to indicate whether or not adding the the label displaying difference in percentage compared to the previous year
#'
#'
#' @param label_font_size Numeric value for label font size, default to 4
#' #' @param category_font_size Numeric value for axis text font size, default to 10
#' #'
#' #' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#' #'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#' #'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#' #'             geom_text
#' #'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' #' @importFrom utils  head
#' #' @importFrom tidyselect where
#' #' @importFrom stringr  str_replace
#' #' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' #' @importFrom stats  reorder aggregate
#' #' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#' #'               pull distinct n arrange across slice left_join
#' #' @importFrom tidyr pivot_longer
#' #' @importFrom unhcrthemes theme_unhcr
#' #'
#' #' @return a ggplot2 object
#' #'
#' #' @export
#' #'
#' #' @examples
#' #' plot_ctr_population_type_abs(
#' #'     year = 2024,
#' #'     country_asylum_iso3c = "USA",
#' #'     top_n_countries = 4,
#' #'     pop_type = "REF",
#' #'     show_diff_label = FALSE,
#' #'     label_font_size = 4,
#' #'     category_font_size = 10
#' #' )
#' #'
#' #' ## Same with 9 top countries and Asylum-seekers included
#' #' plot_ctr_population_type_abs(
#' #'     year = 2024,
#' #'     country_asylum_iso3c = "USA",
#' #'     top_n_countries = 9,
#' #'     pop_type = "ASY",
#' #'     show_diff_label = TRUE,
#' #'     label_font_size = 4,
#' #'     category_font_size = 10
#' #' )
plot_ctr_population_type_abs <- function(
  year = 2024,
  country_asylum_iso3c,
  top_n_countries = 9,
  pop_type = "REF",
  show_diff_label = TRUE,
  label_font_size = 4,
  category_font_size = 10
) {
  dict_pop_type_name <- c(
    "refugees" = "Refugees",
    "returned_refugees" = "Returned refugees",
    "asylum_seekers" = "Asylum-seekers",
    "idps" = "Internally displaced persons",
    "returned_idps" = "Returned idps",
    "oip" = "Other people in need of international protection",
    "stateless" = "Stateless people",
    "ooc" = "Others of concern to UNHCR",
    "hst" = "Host community"
  )

  dict_pop_type_label <- c(
    "refugees" = "REF",
    "returned_refugees" = "RETURNED_REF",
    "asylum_seekers" = "ASY",
    "idps" = "IDP",
    "returned_idps" = "RETURNED_IDP",
    "oip" = "OIP",
    "stateless" = "STA",
    "ooc" = "OOC",
    "hst" = "HST"
  )

  cols_poptype_label <- list(
    ASY = c("Asylum-seekers", "#6CD8FD"),
    REF = c("Refugees", "#0072BC"),
    # VDA = c("Venezuelans Displaced Abroad", "#EF4A60"),
    OIP = c("Other people in need of international protection", "#D25A45"),
    OOC = c("Others of Concern to UNHCR", "#bfbfbf"),
    IDP = c("Internally displaced persons", "#32C189"),
    STA = c("Stateless Persons", "#FFC740")
  )

  df <- refugees::population |>
    dplyr::filter(
      (year == !!year | year == !!year - 1), #### Parameter
      coa_iso == country_asylum_iso3c, #### Parameter
    ) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(
      population_type_label = stringr::str_replace_all(
        population_type,
        pattern = dict_pop_type_label
      )
    ) |>
    dplyr::filter(
      population_type_label %in% pop_type, #### Parameter
      value != 0 | is.na(value)
    ) |>
    dplyr::group_by(
      year,
      coa_name,
      coo_name,
      population_type,
      population_type_label
    ) |>
    dplyr::summarise(
      dplyr::across(tidyselect::where(is.numeric), ~ sum(.x, na.rm = TRUE)),
      .groups = "drop"
    ) |>
    dplyr::mutate(
      population_type_name = stringr::str_replace_all(
        population_type,
        pattern = dict_pop_type_name
      )
    ) |>
    dplyr::group_by(coa_name, coo_name) |>
    dplyr::arrange(year) |>
    dplyr::mutate(
      diff_pop_type_value = scales::label_percent(
        accuracy = 0.1,
        trim = FALSE
      )(((value - dplyr::lag(value)) / dplyr::lag(value)))
    ) |>
    dplyr::ungroup() |>
    dplyr::filter(year == !!year) |>
    dplyr::mutate(
      origin_data_prot = forcats::fct_lump_n(
        f = coo_name,
        n = top_n_countries, #### Parameter
        w = value,
        other_level = "Other nationalities",
        ties.method = "last"
      )
    ) |>
    dplyr::mutate(
      origin_data_prot = forcats::fct_na_value_to_level(
        origin_data_prot,
        "Other nationalities"
      ),
      diff_pop_type_value = dplyr::case_when(
        origin_data_prot == "Other nationalities" ~ "",
        TRUE ~ diff_pop_type_value
      )
    ) |>
    dplyr::group_by(coa_name, diff_pop_type_value, origin_data_prot) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE), .groups = "drop") |>
    dplyr::ungroup() |>
    dplyr::arrange(dplyr::desc(value)) |>
    dplyr::filter(value != 0L) |>
    dplyr::mutate(
      origin_data_prot = forcats::fct_rev(forcats::fct_inorder(
        origin_data_prot
      )),
      origin_data_prot = suppressWarnings(
        dplyr::case_when(
          origin_data_prot == "Other nationalities" ~ forcats::fct_relevel(
            origin_data_prot,
            "Other nationalities",
            after = 0
          ),
          TRUE ~ origin_data_prot
        )
      ),
      perc = scales::label_percent(
        accuracy = 1,
        trim = TRUE
      )(value / sum(value))
    )

  country_name_text <- df |>
    dplyr::distinct(coa_name) |>
    dplyr::pull()

  p <- ggplot2::ggplot() +
    ggplot2::geom_col(
      data = df,
      ggplot2::aes(x = value, y = origin_data_prot),
      fill = cols_poptype_label[[pop_type]][2],
      width = 0.8
    ) +
    ## Position label differently in the bar in white - outside bar in black
    ggplot2::geom_text(
      data = subset(df, value < max(value) / 1.5),
      ggplot2::aes(
        x = value,
        y = origin_data_prot,
        label = scales::label_number(
          accuracy = 1,
          scale_cut = scales::cut_short_scale()
        )(value)
      ),
      hjust = -0.1,
      vjust = 0.5,
      colour = "black",
      size = label_font_size
    ) +
    ggplot2::geom_text(
      data = subset(df, value >= max(value) / 1.5),
      ggplot2::aes(
        x = value,
        y = origin_data_prot,
        label = scales::label_number(
          accuracy = 1,
          scale_cut = scales::cut_short_scale()
        )(value)
      ),
      hjust = 1.1,
      vjust = 0.5,
      colour = "white",
      size = label_font_size
    )

  # Add diff labels
  if (show_diff_label == TRUE) {
    # Prepare data for diff labels
    df_diff <- df |>
      dplyr::filter(
        !is.na(diff_pop_type_value),
        diff_pop_type_value != "",
        diff_pop_type_value != "0.0%"
      ) |>
      dplyr::mutate(
        # Determine change direction
        direction = dplyr::case_when(
          grepl("-", diff_pop_type_value) ~ "negative",
          TRUE ~ "positive"
        ),
        # Determine position type (near bar end vs further out)
        # Matches strict logic from previous geom_text subsets
        pos_type = dplyr::case_when(
          value < max(value) / 1.5 ~ "far",
          TRUE ~ "near"
        ),
        # Assign colors
        icon_color = dplyr::case_when(
          direction == "negative" ~ "#EF4A60", # Red
          TRUE ~ "#589BE5" # Blue
        ),
        # Assign icons
        icon_name = dplyr::case_when(
          direction == "negative" ~ "arrow-down",
          TRUE ~ "arrow-up"
        ),
        # Generate SVG
        svg_icon = as.character(purrr::map2(
          icon_name,
          icon_color,
          ~ fontawesome::fa(.x, fill = .y)
        ))
      )

    # Calculate x-offsets for alignment
    # Main label is at hjust -0.1 (far) or 1.1 (near/inside)
    # We need to position diff labels to the right of the bar tip
    # For 'far': main label is outside, so diff label needs to be further right
    # For 'near': main label is inside, so diff label can be just outside

    # We using offsets relative to max value to simulate 'lines of text' spacing
    max_val <- max(df$value, na.rm = TRUE)
    offset_base <- max_val * 0.02 # Base spacing unit

    # Define Nudge for Icon
    df_diff <- df_diff |>
      dplyr::mutate(
        x_icon = value +
          dplyr::case_when(
            pos_type == "far" ~ offset_base * 4, # Further out to clear main label
            TRUE ~ offset_base * 1 # Just outside
          ),
        x_text = x_icon + offset_base * 2 # Text follows icon
      )

    p <- p +
      ggsvg::geom_point_svg(
        data = df_diff,
        ggplot2::aes(
          x = x_icon,
          y = origin_data_prot,
          svg = svg_icon
        ),
        size = 8.5 # Adjust size as needed
      ) +
      ggplot2::geom_text(
        data = df_diff,
        ggplot2::aes(
          x = x_text,
          y = origin_data_prot,
          label = diff_pop_type_value,
          colour = I(icon_color)
        ),
        hjust = 0, # Left align text starting from x_text
        vjust = 0.5,
        size = label_font_size
      )
  }

  p <- p +
    ggplot2::labs(
      title = paste0(
        country_name_text,
        ": ",
        stringr::str_to_title(names(dict_pop_type_label[
          dict_pop_type_label == pop_type
        ])),
        " | ",
        year
      ),
      subtitle = paste0("Top ", top_n_countries, " Countries of Origin"),
      x = "Number of People",
      caption = "Source: UNHCR.org/refugee-statistics. If the percentage change is 0%, the change is not displayed"
    ) +
    ggplot2::scale_y_discrete(labels = scales::label_wrap(45)) +
    ggplot2::scale_x_continuous(expand = ggplot2::expansion(c(0, 0.1))) +
    unhcrthemes::theme_unhcr(
      grid = FALSE,
      axis = "y",
      axis_title = FALSE,
      axis_text = "y",
      font_size = 14
    ) +
    ggplot2::theme(
      legend.direction = "vertical",
      legend.key.size = unit(0.8, "cm"),
      legend.title = ggplot2::element_blank(),
      text = element_text(size = 20)
    )

  return(p)
}


## Source: plot_ctr_population_type_perc.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Main country of origin - Percentage
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' @param pop_type Character value. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#'
#' @param label_font_size Numeric value for label font size, default to 4
#' @param category_font_size Numeric value for axis text font size, default to 10
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#'
#' @examples
#' plot_ctr_population_type_perc(
#'   year = 2024,
#'   country_asylum_iso3c = "BRA",
#'   top_n_countries = 9,
#'   pop_type = "REF",
#'   show_diff_label = FALSE,
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
#'
#' plot_ctr_population_type_perc(
#'   year = 2024,
#'   country_asylum_iso3c = "BRA",
#'   top_n_countries = 9,
#'   pop_type = "ASY",
#'   show_diff_label = TRUE,
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
plot_ctr_population_type_perc <- function(
  year = 2024,
  country_asylum_iso3c,
  top_n_countries = 9,
  pop_type = "REF",
  show_diff_label = TRUE,
  label_font_size = 4,
  category_font_size = 10
) {
  dict_pop_type_name <- c(
    "refugees" = "Refugees",
    "returned_refugees" = "Returned refugees",
    "asylum_seekers" = "Asylum-seekers",
    "idps" = "Internally displaced persons",
    "returned_idps" = "Returned idps",
    "oip" = "Other people in need of international protection",
    "stateless" = "Stateless people",
    "ooc" = "Others of concern to UNHCR",
    "hst" = "Host community"
  )

  dict_pop_type_label <- c(
    "refugees" = "REF",
    "returned_refugees" = "RETURNED_REF",
    "asylum_seekers" = "ASY",
    "idps" = "IDP",
    "returned_idps" = "RETURNED_IDP",
    "oip" = "OIP",
    "stateless" = "STA",
    "ooc" = "OOC",
    "hst" = "HST"
  )

  cols_poptype_label <- list(
    ASY = c("Asylum-seekers", "#18375F"),
    REF = c("Refugees", "#0072BC"),
    OIP = c("Other people in need of international protection", "#EF4A60"),
    OOC = c("Others of Concern to UNHCR", "#999999"),
    IDP = c("Internally displaced persons", "#00B398"),
    STA = c("Stateless Persons", "#E1CC0D")
  )

  df <- refugees::population |>
    dplyr::filter(
      (year == !!year | year == !!year - 1), #### Parameter
      coa_iso == country_asylum_iso3c, #### Parameter
    ) |>
    tidyr::pivot_longer(
      cols = refugees:hst,
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(
      population_type_label = stringr::str_replace_all(
        population_type,
        pattern = dict_pop_type_label
      )
    ) |>
    dplyr::filter(
      population_type_label %in% pop_type, #### Parameter
      value != 0 | is.na(value)
    ) |>
    dplyr::group_by(
      year,
      coa_name,
      coo_name,
      population_type,
      population_type_label
    ) |>
    dplyr::summarise(
      across(where(is.numeric), ~ sum(.x, na.rm = TRUE)),
      .groups = "drop"
    ) |>
    dplyr::mutate(
      population_type_name = stringr::str_replace_all(
        population_type,
        pattern = dict_pop_type_name
      )
    ) |>
    group_by(coa_name, coo_name) |>
    arrange(year) |>
    mutate(
      diff_pop_type_value = scales::label_percent(
        accuracy = 0.1,
        trim = FALSE
      )(((value - lag(value)) / lag(value)))
    ) |>
    ungroup() |>
    filter(year == !!year) |>
    mutate(
      origin_data_prot = forcats::fct_lump_n(
        f = coo_name,
        n = top_n_countries, #### Parameter
        w = value,
        other_level = "Other nationalities",
        ties.method = "last"
      )
    ) |>
    mutate(
      origin_data_prot = forcats::fct_na_value_to_level(
        origin_data_prot,
        "Other nationalities"
      ),
      diff_pop_type_value = case_when(
        origin_data_prot == "Other nationalities" ~ "",
        TRUE ~ diff_pop_type_value
      )
    ) |>
    group_by(coa_name, diff_pop_type_value, origin_data_prot) |>
    summarise(value = sum(value, na.rm = TRUE), .groups = "drop") |>
    ungroup() |>
    arrange(desc(value)) |>
    filter(value != 0L) |>
    mutate(
      origin_data_prot = forcats::fct_rev(forcats::fct_inorder(
        origin_data_prot
      )),
      origin_data_prot = suppressWarnings(
        case_when(
          origin_data_prot == "Other nationalities" ~ forcats::fct_relevel(
            origin_data_prot,
            "Other nationalities",
            after = 0
          ),
          TRUE ~ origin_data_prot
        )
      ),
      perc = scales::label_percent(
        accuracy = 1,
        trim = FALSE
      )(value / sum(value))
    )

  country_name_text <- df |>
    distinct(coa_name) |>
    pull()

  p <- ggplot() +
    geom_col(
      data = df,
      aes(x = value, y = origin_data_prot),
      fill = cols_poptype_label[[pop_type]][2],
      width = 0.8
    ) +
    ## Position label differently in the bar in white - outside bar in black
    geom_text(
      data = subset(df, value < max(value) / 1.5),
      aes(
        x = value,
        y = origin_data_prot,
        label = perc
      ),
      hjust = -0.1,
      vjust = 0.5,
      colour = "black",
      size = label_font_size
    ) +
    geom_text(
      data = subset(df, value >= max(value) / 1.5),
      aes(
        x = value,
        y = origin_data_prot,
        label = perc
      ),
      hjust = 1.1,
      vjust = 0.5,
      colour = "white",
      size = label_font_size
    )

  # Add diff labels
  # Add diff labels
  if (show_diff_label == TRUE) {
    # Prepare data for diff labels
    df_diff <- df |>
      dplyr::filter(
        !is.na(diff_pop_type_value),
        diff_pop_type_value != "",
        diff_pop_type_value != "0.0%"
      ) |>
      dplyr::mutate(
        # Determine change direction
        direction = dplyr::case_when(
          grepl("-", diff_pop_type_value) ~ "negative",
          TRUE ~ "positive"
        ),
        # Determine position type (near bar end vs further out)
        # Matches strict logic from previous geom_text subsets
        pos_type = dplyr::case_when(
          value < max(value) / 1.5 ~ "far",
          TRUE ~ "near"
        ),
        # Assign colors
        icon_color = dplyr::case_when(
          direction == "negative" ~ "#EF4A60", # Red
          TRUE ~ "#589BE5" # Blue
        ),
        # Assign icons
        icon_name = dplyr::case_when(
          direction == "negative" ~ "arrow-down",
          TRUE ~ "arrow-up"
        ),
        # Generate SVG
        svg_icon = as.character(purrr::map2(
          icon_name,
          icon_color,
          ~ fontawesome::fa(.x, fill = .y)
        ))
      )

    # Calculate x-offsets for alignment
    # Main label is at hjust -0.1 (far) or 1.1 (near/inside)
    # We need to position diff labels to the right of the bar tip
    # For 'far': main label is outside, so diff label needs to be further right
    # For 'near': main label is inside, so diff label can be just outside

    # We using offsets relative to max value to simulate 'lines of text' spacing
    max_val <- max(df$value, na.rm = TRUE)
    offset_base <- max_val * 0.02 # Base spacing unit

    # Define Nudge for Icon
    df_diff <- df_diff |>
      dplyr::mutate(
        x_icon = value +
          dplyr::case_when(
            pos_type == "far" ~ offset_base * 4, # Further out to clear main label
            TRUE ~ offset_base * 1 # Just outside
          ),
        x_text = x_icon + offset_base * 2 # Text follows icon
      )

    p <- p +
      ggsvg::geom_point_svg(
        data = df_diff,
        ggplot2::aes(
          x = x_icon,
          y = origin_data_prot,
          svg = svg_icon
        ),
        size = 8.5 # Adjust size as needed
      ) +
      ggplot2::geom_text(
        data = df_diff,
        ggplot2::aes(
          x = x_text,
          y = origin_data_prot,
          label = diff_pop_type_value,
          colour = I(icon_color)
        ),
        hjust = 0, # Left align text starting from x_text
        vjust = 0.5,
        size = label_font_size
      )
  }

  p <- p +
    labs(
      title = paste0(
        country_name_text,
        ": ",
        stringr::str_to_title(names(dict_pop_type_label[
          dict_pop_type_label == pop_type
        ])),
        " | ",
        year
      ),
      subtitle = paste0("Top ", top_n_countries, " Countries of Origin"),
      x = "Number of People",
      caption = "Source: UNHCR.org/refugee-statistics. If the percentage change is 0%, the change is not displayed"
    ) +
    ggplot2::scale_y_discrete(labels = scales::label_wrap(45)) +
    ggplot2::scale_x_continuous(expand = ggplot2::expansion(c(0, 0.1))) +
    theme_unhcr(
      grid = FALSE,
      axis = "y",
      axis_title = FALSE,
      axis_text = "y",
      font_size = 14
    ) +
    theme(
      legend.direction = "vertical",
      legend.key.size = unit(0.8, "cm"),
      text = element_text(size = 20),
      axis.text.y = element_text(size = category_font_size),
      legend.title = element_blank()
    )

  return(p)
}


## Source: plot_ctr_population_type_per_year.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Graph of Population Type Over year
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param lag Number of year to used as comparison base
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type
#'                  (e.g.: REF, IDP, ASY, OIP, OIP, OOC, STA)
#'
#' @import ggplot2
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#'
#'
#' @examples
#' p <- plot_ctr_population_type_per_year(
#'   year = 2024,
#'   country_asylum_iso3c = "BRA",
#'   lag = 5,
#'   pop_type = c(
#'     "REF",
#'     "ASY",
#'     "OIP",
#'     "OOC",
#'     "STA",
#'     "IDP"
#'   )
#' )
#' p
#' ## Raw data can always be accessed with
#' # knitr::kable(ggplot2::ggplot_build(p)$plot$data )
plot_ctr_population_type_per_year <- function(
  year = 2024,
  lag = 5,
  country_asylum_iso3c,
  pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC"),
  label_font_size = 4,
  category_font_size = 10,
  legend_font_size = 10
) {
  dict_pop_type_name <- c(
    "refugees" = "Refugees",
    "returned_refugees" = "Returned refugees",
    "asylum_seekers" = "Asylum-seekers",
    "idps" = "Internally displaced persons",
    "returned_idps" = "Returned idps",
    "oip" = "Other people in need of international protection",
    "stateless" = "Stateless people",
    "ooc" = "Others of concern to UNHCR",
    "hst" = "Host community"
  )

  dict_pop_type_label <- c(
    "refugees" = "REF",
    "returned_refugees" = "RETURNED_REF",
    "asylum_seekers" = "ASY",
    "idps" = "IDP",
    "returned_idps" = "RETURNED_IDP",
    "oip" = "OIP",
    "stateless" = "STA",
    "ooc" = "OOC",
    "hst" = "HST"
  )

  cols_poptype <- c(
    "Asylum-seekers" = "#18375F",
    "Refugees" = "#0072BC",
    # "Venezuelans Displaced Abroad" = "#EF4A60",
    "Other people in need of international protection" = "#EF4A60",
    "Others of Concern to UNHCR" = "#999999",
    "Internally displaced persons" = "#00B398",
    "Stateless Persons" = "#E1CC0D"
  )

  df <- refugees::population |>
    dplyr::filter(
      year >= (!!year - lag) & year <= !!year, #### Parameter
      coa_iso == country_asylum_iso3c, #### Parameter
    ) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(
      population_type_label = stringr::str_replace_all(
        population_type,
        pattern = dict_pop_type_label
      )
    ) |>
    dplyr::filter(
      population_type_label %in% pop_type #### Parameter
    ) |>
    dplyr::group_by(year, coa_name, population_type, population_type_label) |>
    dplyr::summarise(
      dplyr::across(tidyselect::where(is.numeric), ~ sum(.x, na.rm = TRUE)),
      .groups = "drop"
    ) |>
    dplyr::mutate(
      population_type_name = stringr::str_replace_all(
        population_type,
        pattern = dict_pop_type_name
      )
    )

  ## need to sort with so that the small value are on the top for better legibility
  # levels(as.factor(df$population_type_label)) is alpha...
  # let's sort based on value from this year
  df$population_type_name <- factor(
    df$population_type_name,
    levels = unique(df$population_type_name[order(df$value)])
  )

  country_name_text <- df |>
    dplyr::distinct(coa_name) |>
    dplyr::pull()

  year_breaks <- diff(range(df$year)) + 1

  p <- ggplot2::ggplot() +
    ggplot2::geom_col(
      data = df,
      ggplot2::aes(
        x = year,
        y = value,
        fill = population_type_name
      ),
      width = 0.7
    ) +

    ## Need some conditions to put labels or not o the chart - to avoid cluttered
    # chart..

    ggplot2::geom_text(
      data = df |> dplyr::filter(value > mean(df$value) * 0.1),
      ggplot2::aes(
        x = year,
        y = value,
        color = population_type_name,
        label = scales::label_number(
          accuracy = .1,
          scale_cut = scales::cut_short_scale()
        )(value)
      ),
      position = ggplot2::position_stack(vjust = 0.5),
      show.legend = FALSE,
      size = label_font_size
    ) +
    ## This add the total on the top of the chart..
    ggplot2::stat_summary(
      data = df,
      fun = sum,
      ggplot2::aes(
        x = year,
        y = value,
        label = scales::label_number(
          accuracy = .1,
          scale_cut = scales::cut_short_scale()
        )(ggplot2::after_stat(y)),
        group = year
      ),
      geom = "text",
      size = label_font_size,
      vjust = -0.5
    ) +
    ggplot2::scale_color_manual(
      values = c(
        "#FFFFFF",
        "#FFFFFF",
        "#FFFFFF",
        "#FFFFFF",
        "#FFFFFF",
        "#FFFFFF"
      )
    ) +
    ggplot2::scale_fill_manual(
      values = cols_poptype,
      drop = TRUE,
      limits = force,
      labels = scales::label_wrap(20)
    ) +
    ggplot2::guides(fill = ggplot2::guide_legend(nrow = 2, byrow = TRUE)) +
    ggplot2::scale_x_continuous(breaks = scales::breaks_width(1)) +
    ggplot2::scale_y_continuous(expand = ggplot2::expansion(c(0, 0.1))) +
    ggplot2::labs(
      title = paste0(country_name_text, ": Population Type per year"),
      subtitle = "Number of people (thousand)",
      caption = "Source: UNHCR.org/refugee-statistics"
    ) +
    unhcrthemes::theme_unhcr(
      grid = FALSE,
      axis = "x",
      axis_title = FALSE,
      axis_text = "x",
      font_size = 14
    ) +
    ggplot2::theme(legend.title = ggplot2::element_blank()) +
    ggplot2::theme(
      legend.direction = "horizontal",
      legend.position = "bottom",
      legend.key.size = ggplot2::unit(0.8, "cm"),
      text = ggplot2::element_text(size = 20),
      axis.text.x = element_text(size = category_font_size),
      legend.text = element_text(size = legend_font_size),
      legend.title = element_blank()
    )

  return(p) # print(p)
}


## Source: plot_ctr_process.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Asylum Processing
#'
#' Displaying Asylum processing
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param otherprop value set by default to .02 - used to merge origin as "Other"
#'
#'
#' @param label_font_size Numeric value for label font size, default to 4
#' @param category_font_size Numeric value for axis text font size, default to 10
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text guide_axis facet_wrap vars theme_void
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace str_wrap
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join rename count
#' @importFrom tidyr pivot_longer
#' @importFrom forcats fct_relevel
#' @importFrom  ggforce geom_parallel_sets geom_parallel_sets_axes
#'                  geom_parallel_sets_labels gather_set_data
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#' @examples
#' plot_ctr_process(
#'   year = 2024,
#'   country_asylum_iso3c = "BOL",
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
#'
#' plot_ctr_process(
#'   year = 2024,
#'   country_asylum_iso3c = "CHL",
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
#'
#'
#' plot_ctr_process(
#'   year = 2024, country_asylum_iso3c = "USA",
#'   otherprop = .02,
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
#'
#' plot_ctr_process(
#'   year = 2024, country_asylum_iso3c = "USA",
#'   otherprop = .04,
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
plot_ctr_process <- function(
  year = 2024,
  country_asylum_iso3c,
  otherprop = .02,
  label_font_size = 4,
  category_font_size = 10
) {
  country_name_text <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::distinct(coa_name) |>
    dplyr::pull() |>
    head(1)

  links <- refugees::asylum_decisions |>
    dplyr::filter(year == year & coa_iso == country_asylum_iso3c) |>
    dplyr::rename(CountryOriginName = coo_name) |>
    dplyr::mutate(
      CountryOriginName = forcats::fct_lump_prop(
        CountryOriginName,
        prop = otherprop,
        w = dec_total
      )
    ) |>
    tidyr::pivot_longer(
      cols = c(dec_recognized, dec_other, dec_rejected, dec_closed),
      names_to = "Decision.output",
      values_to = "value"
    ) |>
    dplyr::mutate(
      Decision.output = dplyr::case_when(
        Decision.output == "dec_recognized" ~ "Recognized",
        Decision.output == "dec_other" ~ "Complementary\nProtection",
        Decision.output == "dec_rejected" ~ "Rejected",
        Decision.output == "dec_closed" ~ "Otherwise\nClosed"
      ),
      ProcedureName = dplyr::case_when(
        dec_level == "G" ~ "Government",
        dec_level == "U" ~ "UNHCR",
        dec_level == "J" ~ "Joint",
        TRUE ~ "Unknown"
      )
    ) |>
    dplyr::group_by(CountryOriginName, ProcedureName, Decision.output) |>
    dplyr::summarise(n = sum(value, na.rm = TRUE))
  # levels(links$Decision.output)

  ## Case no record outut a ggplot2 object with anotation
  if (nrow(links) == 0) {
    info <- paste0(
      "There's no recorded Asylum Decisions \n in ",
      country_name_text,
      " for ",
      year
    )
    p <- ggplot() +
      annotate(
        stringr::str_wrap("text", 80),
        x = 1,
        y = 1,
        size = 11,
        label = info
      ) +
      theme_void()
  } else {
    ## summarize data
    # Rename columns for better display
    links_renamed <- links |>
      dplyr::rename(
        `Country of Origin` = CountryOriginName,
        `Procedure` = ProcedureName,
        `Decision output` = Decision.output
      ) |>
      dplyr::mutate(
        `Country of Origin` = stringr::str_wrap(`Country of Origin`, width = 20)
      )

    flow_table <- links_renamed |>
      ggforce::gather_set_data(
        x = c("Country of Origin", "Procedure", "Decision output")
      )

    flow_table[["Decision output"]] <- factor(
      flow_table[["Decision output"]],
      levels = c(
        "Rejected",
        "Complementary\nProtection",
        "Recognized",
        "Otherwise\nClosed"
      )
    )
    ## plot your dataset
    ## on the x axis is the start and end causes
    ## gather_set_data generates an ID for each possible combination
    ## splitting by y gives the possible start/end combos
    ## value as n gives it as counts (could also be changed to proportion)
    p <- ggplot(
      flow_table,
      aes(x, id = id, split = y, value = n)
    ) +
      ## colour lines by sex
      ggforce::geom_parallel_sets(
        aes(fill = `Decision output`),
        alpha = 0.5,
        axis.width = 0.2
      ) +
      ## fill in the label boxes grey
      ggforce::geom_parallel_sets_axes(
        axis.width = 0.15,
        fill = "grey80",
        color = "grey80"
      ) +
      ## change text colour and angle (needs to be adjusted)
      ggforce::geom_parallel_sets_labels(
        color = "black",
        angle = 0,
        size = label_font_size
      ) +
      ## adjusted y and x axes (probably needs more vertical space)
      scale_x_discrete(
        labels = scales::label_wrap(25),
        name = NULL,
        expand = c(0, 0.2)
      ) +
      theme_unhcr(
        font_size = 14,
        grid = FALSE
      ) +
      ## remove axis labels
      theme(
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "none", # move legend to bottom
        legend.title = element_blank(), # remove title
        axis.text.x = element_text(size = category_font_size)
      ) +
      labs(
        title = "Refugee Status Determination Decisions",
        subtitle = paste0(
          country_name_text,
          ", ",
          format(sum(links$n), big.mark = ","),
          " decisions recorded in ",
          year
        ),
        x = NULL,
        y = NULL,
        caption = "Source: UNHCR.org/refugee-statistics"
      )
  }
  return(p)
}


## Source: plot_ctr_processing_time.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Plot Average processing time from registration to first instance asylum decision
#'
#' This indicator measures the average number of days from the date of completion of registration of the asylum application to the date of notification of first instance asylum decision for all persons who were notified of a first instance RSD/asylum decision during the reporting period.
#'
#' Status determination procedures are a core protection function and the principle mechanism through which international protection needs of Persons of Concern may be determined in accordance with the key provisions of the 1951 Convention and 1967 Protocol relating to the Status of Refugees, the 1954 Convention relating to the Status of Stateless Persons, or relevant regional refugee protection instruments. Status determination procedures are therefore central to the full and effective enjoyment of the universal right to seek and enjoy asylum and the specific rights guaranteed by the above instruments.
#'
#' A prolonged waiting period during the status determination procedure is an important indicator of the state of efficiency, fairness, adaptability integrity and hence, overall quality of the national asylum or, depending on the context, UNHCR Mandate RSD procedure, including the timeliness and effectiveness of the overall protection response in the country.
#'
#'  (RBM Outcome Indicator 2.1) - see [UNHCR Intranet](https://intranet.unhcr.org/content/dam/unhcr/intranet/protection-operations/compass/en/guidance/3/coreindicatorsmetadata/2.0%20Core%20Indicator%20Metadata%2004%2010%202021.pdf#page=67) - Credit to Hisham Galal for the chart initial idea and script
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#'
#' @param country_origin_iso3c Character value with the ISO-3 character code of the Country of Asylum - if NUL then all countries are included
#'
#' @param procedureType indicates whether "G" (Government) "J" (Joint) "U" (UNHCR)
#' @param lag Numeric value for the time window to display, default to 10 years
#' @param label_font_size Numeric value for label font size, default to 4
#' @param category_font_size Numeric value for axis text font size, default to 10
#' @param legend_font_size Numeric value for legend font size, default to 10
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual guides guide_legend
#'             geom_text guide_axis facet_wrap vars geom_area annotate
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme  scale_fill_manual
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom tidyr pivot_longer
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join last transmute
#' @importFrom purrr detect_index
#' @importFrom lubridate date_decimal interval days make_date
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#' @examples
#' plot_ctr_processing_time(
#'   year = 2024,
#'   country_asylum_iso3c = "ARG",
#'   label_font_size = 4,
#'   category_font_size = 10,
#'   legend_font_size = 10
#' )
#'
#'
#' plot_ctr_processing_time(
#'   year = 2024,
#'   country_asylum_iso3c = "USA",
#'   label_font_size = 4,
#'   category_font_size = 10,
#'   legend_font_size = 10
#' )
#'
#' ## Display a filtered version of the chart for a specific country and procedure
#' plot_ctr_processing_time(
#'   year = 2024,
#'   country_asylum_iso3c = "EGY",
#'   country_origin_iso3c = "ERI",
#'   procedureType = "U",
#'   label_font_size = 4,
#'   category_font_size = 10,
#'   legend_font_size = 10
#' )
plot_ctr_processing_time <- function(
  year = 2024,
  country_asylum_iso3c = country_asylum_iso3,
  country_origin_iso3c = NULL,
  procedureType = NULL,
  lag = 10,
  label_font_size = 4,
  category_font_size = 10,
  legend_font_size = 10
) {
  country_name_text <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::distinct(coa_name) |>
    dplyr::pull() |>
    utils::head(1)

  if (is.null(country_origin_iso3c)) {
    originfilterlab <- ""
  } else {
    originfilterlab <- refugees::population |>
      dplyr::filter(coo_iso == country_origin_iso3c) |>
      dplyr::distinct(coo_name) |>
      dplyr::pull() |>
      utils::head(1)
  }

  # Procedure filtering is not supported with refugees package in this version
  procedurefilterlab <- ""

  filterlab <- paste0(
    dplyr::if_else(
      originfilterlab == "",
      "",
      paste0(", filtered for nationals from ", originfilterlab)
    )
  )

  apps <- refugees::asylum_applications |>
    dplyr::filter(
      coa_iso == country_asylum_iso3c,
      year >= (!!year - lag)
    )

  if (!is.null(country_origin_iso3c)) {
    apps <- apps |> dplyr::filter(coo_iso == country_origin_iso3c)
  }

  apps <- apps |>
    dplyr::mutate(DecisionTypeCode = "FI") |> # Assumption: All applications are considered
    dplyr::group_by(year, coa_iso) |>
    dplyr::summarize(NumberApplications = sum(applied, na.rm = TRUE)) |>
    dplyr::rename(CountryAsylumCode = coa_iso) |>
    dplyr::ungroup()

  decs <- refugees::asylum_decisions |>
    dplyr::filter(
      coa_iso == country_asylum_iso3c,
      year >= (!!year - lag)
    )

  if (!is.null(country_origin_iso3c)) {
    decs <- decs |> dplyr::filter(coo_iso == country_origin_iso3c)
  }

  decs <- decs |>
    dplyr::mutate(DecisionTypeCode = "FI") |> # Assumption: All decisions are considered
    dplyr::group_by(year, coa_iso) |>
    dplyr::summarize(TotalDecided = sum(dec_total, na.rm = TRUE)) |>
    dplyr::rename(CountryAsylumCode = coa_iso) |>
    dplyr::ungroup()

  data <-
    dplyr::left_join(
      apps |> dplyr::select(year, CountryAsylumCode, NumberApplications),
      decs |> dplyr::select(year, CountryAsylumCode, TotalDecided),
      by = c("year", "CountryAsylumCode")
    ) |>
    dplyr::arrange(year) |>
    dplyr::mutate(dplyr::across(
      c(NumberApplications, TotalDecided),
      ~ tidyr::replace_na(., 0)
    )) |>
    dplyr::transmute(
      year = dplyr::if_else(year == dplyr::last(year), year + .5, year + 1),
      apps = cumsum(NumberApplications),
      decs = cumsum(TotalDecided)
    )

  idx <- purrr::detect_index(
    data$apps,
    ~ . < dplyr::last(data$decs),
    .dir = "backward"
  )

  t <- lubridate::date_decimal(
    data$year[idx] +
      (dplyr::last(data$decs) - data$apps[idx]) /
        (data$apps[idx + 1] - data$apps[idx])
  )

  stat <- lubridate::interval(t, lubridate::make_date(2022, 6, 30)) /
    lubridate::days()

  data2 <- data |>
    tidyr::pivot_longer(-year, names_to = "flow", values_to = "n")

  p <- data2 |>
    ggplot2::ggplot(ggplot2::aes(year, n, fill = flow)) +
    ggplot2::geom_area(position = "identity") +
    ## highlight the main indicator!
    ggplot2::annotate(
      "segment",
      x = lubridate::decimal_date(t),
      y = dplyr::last(data$decs),
      xend = dplyr::last(data$year),
      yend = dplyr::last(data$decs)
    ) +
    ggplot2::annotate(
      "text",
      x = 2020,
      y = dplyr::last(data$decs),
      vjust = -.5,
      label = paste0(round(stat), " days"),
      size = label_font_size
    ) +
    ggplot2::scale_x_continuous(breaks = scales::breaks_width(1)) +
    ggplot2::scale_y_continuous(labels = scales::label_comma()) +
    ggplot2::scale_fill_manual(
      labels = c(
        decs = "Decisions",
        apps = "Applications"
      ),
      values = c(
        decs = "#0072BC",
        apps = "#FAEB00"
      ),
      name = NULL
    ) +
    ggplot2::labs(
      title = stringr::str_wrap(
        "Average Processing Time from Asylum Registration to First Instance Decision",
        100
      ),
      subtitle = paste0(
        "In ",
        country_name_text,
        ", comparative cumulative applications and decisions with gap measured in days as of ",
        year,
        filterlab
      ),
      x = NULL,
      y = "Cumulative total",
      caption = "Source: UNHCR.org/refugee-statistics"
    ) +
    ggplot2::guides(fill = ggplot2::guide_legend(reverse = TRUE)) +
    unhcrthemes::theme_unhcr(
      font_size = 14,
      grid = "Y"
    ) +
    ggplot2::theme(
      legend.position = "top",
      axis.text = element_text(size = category_font_size),
      legend.text = element_text(size = legend_font_size),
      legend.title = element_blank()
    )

  return(p)
}


## Source: plot_ctr_pyramid.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Population Pyramid
#'
#' @param year Numeric value of the year (for instance 2022).
#'             If the data is not yet available for that year (aka still in the mid year reporting stage),
#'              it will automatically fall back on the previous year
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#'
#' @param label_font_size Numeric value for label font size, default to 4
#' @param category_font_size Numeric value for axis text font size, default to 10
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text .pt theme_void
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head download.file
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace str_detect
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate  setNames
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer pivot_wider
#' @importFrom unhcrthemes theme_unhcr unhcr_pal
#'
#' @return a ggplot2 object
#'
#' @export
#'
#' @examples
#' #
#' plot_ctr_pyramid(
#'   year = 2024,
#'   country_asylum_iso3c = "COL",
#'   pop_type = c("ASY", "REF"),
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
plot_ctr_pyramid <- function(
  year = 2024,
  country_asylum_iso3c,
  pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC"),
  label_font_size = 4,
  category_font_size = 10
) {
  country_name_text <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::distinct(coa_name) |>
    dplyr::pull() |>
    head(1)

  ctrylabel <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::distinct(coa_name) |>
    dplyr::pull() |>
    head(1)

  poptype_label <- pop_type

  demographics1 <- refugees::demographics |>
    dplyr::filter(
      coa_iso == country_asylum_iso3c,
      year == year
    ) |>
    dplyr::mutate(
      Total = f_total + m_total,
      totGen = f_total + m_total,
      totbreak = f_0_4 +
        f_5_11 +
        f_12_17 +
        f_18_59 +
        f_60 +
        f_other +
        m_0_4 +
        m_5_11 +
        m_12_17 +
        m_18_59 +
        m_60 +
        m_other,
      hasbreak = ifelse(Total - totGen == 0, "yes", "no")
    )

  ## Check if fall back is needed..
  ## Check if fall back is needed..
  if (nrow(demographics1) == 0) {
    year <- year - 1
    demographics1 <- refugees::demographics |>
      dplyr::filter(
        coa_iso == country_asylum_iso3c,
        year == year
      ) |>
      dplyr::mutate(
        Total = f_total + m_total,
        totGen = f_total + m_total,
        totbreak = f_0_4 +
          f_5_11 +
          f_12_17 +
          f_18_59 +
          f_60 +
          f_other +
          m_0_4 +
          m_5_11 +
          m_12_17 +
          m_18_59 +
          m_60 +
          m_other,
        hasbreak = ifelse(Total - totGen == 0, "yes", "no")
      )
  }

  if (nrow(demographics1) == 0) {
    info <- paste0(
      "No Gender disaggregation recorded\n for Forcibly Displaced People across Borders \n in ",
      ctrylabel,
      " as of ",
      year
    )

    p <- ggplot() +
      annotate("text", x = 1, y = 1, size = 12, label = info) +
      theme_void()
  } else {
    tot <- format(sum(demographics1$Total), big.mark = ",")
    totprop <- format(
      round(
        sum(demographics1$totGen) /
          sum(demographics1$Total) *
          100,
        1
      ),
      big.mark = ","
    )

    if (totprop == 0) {
      info <- paste0(
        "There\'s no recorded Gender disaggregation \n for  all of the ",
        tot,
        " persons \n in ",
        country_name_text
      )
      p <- ggplot() +
        annotate("text", x = 1, y = 1, size = 12, label = info) +
        theme_void()
    } else {
      # names(demographics)
      pyramid <- demographics1[
        demographics1$year == max(demographics1$year),
        c(
          "f_0_4",
          "f_5_11",
          "f_12_17",
          "f_18_59",
          "f_60",
          "f_other",
          "m_0_4",
          "m_5_11",
          "m_12_17",
          "m_18_59",
          "m_60",
          "m_other"
        )
      ]

      pyramid2 <- data.frame(lapply(pyramid, function(x) {
        as.numeric(gsub("NA", "0", x))
      })) |>
        pivot_longer(
          cols = f_0_4:m_other,
          names_to = "Class",
          values_to = "Sum",
          values_drop_na = TRUE
        )

      pyramid3 <- as.data.frame(aggregate(
        pyramid2$Sum,
        by = list(
          pyramid2$Class # , pyramid2$REGION_UN
        ),
        sum
      ))
      names(pyramid3)[1] <- "Class"
      names(pyramid3)[2] <- "Count"

      pyramid3 <- pyramid3 |>
        mutate(
          gender = case_when(
            str_detect(Class, "^m_") ~ "Male",
            str_detect(Class, "^f_") ~ "Female"
          )
        ) |>
        mutate(
          age = case_when(
            str_detect(Class, "0_4") ~ "0-4",
            str_detect(Class, "5_11") ~ "5-11",
            str_detect(Class, "12_17") ~ "12-17",
            str_detect(Class, "18_59") ~ "18-59",
            str_detect(Class, "60") ~ "60+",
            str_detect(Class, "unknown") ~ "Unknown"
          )
        ) |>
        # Filter out Unknown if count is 0
        dplyr::filter(!(age == "Unknown" & Count == 0))

      pyramid3$pc <- pyramid3$Count / sum(pyramid3$Count)
      pyramid3$age <- factor(
        pyramid3$age,
        levels = c("0-4", "5-11", "12-17", "18-59", "60+", "Unknown")
      )

      pyramid4 <- pyramid3 |>
        select(gender, age, pc) |>
        mutate(gender = tolower(gender)) |>
        pivot_wider(
          names_from = gender,
          names_sort = TRUE,
          values_from = pc
        )

      p <- ggplot() +
        geom_col(
          data = pyramid4,
          aes(-male, age, fill = "Male"),
          width = 0.7
        ) +
        geom_col(
          data = pyramid4,
          aes(female, age, fill = "Female"),
          width = 0.7
        ) +
        geom_text(
          data = pyramid4,
          aes(-male, age, label = percent(abs(male), accuracy = 1)),
          hjust = 1.25,
          size = label_font_size
        ) +
        geom_text(
          data = pyramid4,
          aes(female, age, label = percent(abs(female), accuracy = 1)),
          hjust = -0.25,
          size = label_font_size
        ) +
        ## Now get the icon for male and female
        # ggtext::geom_textbox(aes(x = 0.25,
        #                           y = "60+",
        #                 label = "\uf182" ),
        #                family = "Font Awesome 6 Free Solid",
        #                color = "#18375F",# "#0072BC" "#8EBEFF"
        #                box.colour = NA ,   hjust = 0,   vjust = 0,
        #                width = unit(0.4, "npc"),
        #               size = 11.5 ) +
        # ggtext::geom_textbox(aes(x = as.numeric(-0.25),
        #                          y = "60+",
        #                label = "\uf183" ),
        #               family = "Font Awesome 6 Free Solid",
        #                color = "#0072BC",# "#0072BC" "#8EBEFF"
        #               box.colour = NA ,   hjust = 0,   vjust = 0,
        #                width = unit(0.4, "npc"),
        #              size = 11.5 ) +
        scale_x_continuous(expand = expansion(c(0.2, 0.2))) +
        scale_fill_manual(
          breaks = c("Male", "Female"),
          values = setNames(
            unhcrthemes::unhcr_pal(n = 3, "pal_unhcr")[c(2, 1)],
            c("Male", "Female")
          )
        ) +
        labs(
          title = paste0(
            "Population Pyramid for ",
            sub(",\\s+([^,]+)$", " and \\1", toString(poptype_label)),
            " | ",
            ctrylabel
          ),
          subtitle = paste0(
            " As of ",
            year,
            ", gender disaggregation is available for ",
            totprop,
            "% of the ",
            tot,
            " individuals in ",
            country_name_text
          ),
          caption = "Note: figures do not add up to 100 per cent due to rounding\nSource: UNHCR.org/refugee-statistics."
        ) +
        theme_unhcr(
          font_size = 14,
          grid = FALSE,
          axis = FALSE,
          axis_title = FALSE,
          axis_text = "y"
        ) +
        theme(
          legend.position = "bottom",
          legend.title = ggplot2::element_blank(),
          axis.text = element_text(size = category_font_size)
        )
    }
  }

  return(p)
}


## Source: plot_ctr_recognition.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Display a Chart with Refugee Recognition Rates
#'
#' In the absence of an internationally agreed methodology for calculating recognition rates,
#'  UNHCR uses two rates to compute the proportion of refugee claims accepted during the year:
#'
#'   * The Refugee Recognition Rate divides the number of asylum-seekers granted Convention refugee
#'   status by the total number of accepted (Convention and, where relevant, complementary
#'   protection) and rejected cases (aka substantive decision).
#'
#'   * The Total Recognition Rate divides the number of asylum-seekers granted Convention
#'    refugee status and / or complementary form of protection by the total number
#'    of accepted (Convention and, where relevant, complementary protection) and
#'     rejected cases.
#'
#' Non-substantive decisions are, to the extent possible, excluded from both
#' calculations. For the purpose of international comparability,  UNHCR only
#' uses these two recognition rates and does not report nationally calculated rates.
#'
#'      See https://www.unhcr.org/4ce531e09.pdf
#'
#' @param year Numeric value of the year
#'
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param top_n_countries Numeric value of number of main countries that the graph should display
#' @param measure this can be either:
#'            * RefugeeRecognitionRate
#'            * TotalRecognitionRate
#' @param order_by this can be either:
#'            * Recognized
#'            * ComplementaryProtection
#'            * TotalDecided
#'
#' @param label_font_size Numeric value for label font size, default to 4
#' @param category_font_size Numeric value for axis text font size, default to 10
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text guide_axis facet_wrap vars
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty pretty_breaks
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr  scale_fill_unhcr_d
#'
#' @return a ggplot2 object
#'
#' @export
#' @examples
#' plot_ctr_recognition(
#'   year = 2024,
#'   country_asylum_iso3c = "USA",
#'   top_n_countries = 10,
#'   measure = "RefugeeRecognitionRate",
#'   order_by = "TotalDecided",
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
plot_ctr_recognition <- function(
  year = 2024,
  country_asylum_iso3c,
  top_n_countries = 10,
  measure = "RefugeeRecognitionRate",
  order_by = "TotalDecided",
  label_font_size = 4,
  category_font_size = 10
) {
  country_name_text <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::distinct(coa_name) |>
    dplyr::pull() |>
    head(1)

  measurelabel <-
    dplyr::case_when(
      measure == "RefugeeRecognitionRate" ~ "Refugee Recognition Rate",
      measure == "TotalRecognitionRate" ~ "Total Recognition Rate"
    )

  order_bylabel <-
    dplyr::case_when(
      order_by == "Recognized" ~ "Recognized Refugee Status Decisions",
      order_by ==
        "ComplementaryProtection" ~ "Complementary Protection Decisions",
      order_by ==
        "TotalDecided" ~ "Total Decision (independently of the outcome)"
    )

  topOrigin <- refugees::asylum_decisions |>
    dplyr::filter(coa_iso == country_asylum_iso3c & year == year) |>
    dplyr::mutate(DecisionsAveragePersonsPerCase = 1) |>
    dplyr::rename(CountryOriginName = coo_name) |>
    dplyr::group_by(CountryOriginName) |>
    dplyr::summarize(
      Recognized = sum(dec_recognized, na.rm = TRUE),
      ComplementaryProtection = sum(dec_other, na.rm = TRUE),
      TotalDecided = sum(dec_total, na.rm = TRUE)
    ) |>
    dplyr::mutate(
      RefugeeRecognitionRate = (Recognized) / TotalDecided,
      TotalRecognitionRate = (Recognized + ComplementaryProtection) /
        TotalDecided
    ) |>
    dplyr::mutate(
      CountryOriginName = str_replace(
        CountryOriginName,
        " \\(Bolivarian Republic of\\)",
        ""
      )
    )

  topOrigin1 <- topOrigin |>
    mutate(measured = .data[[measure]]) |>
    mutate(order_by = .data[[order_by]]) |>
    arrange(desc(order_by)) |>
    head(top_n_countries)

  rsdorigin <- ggplot() +
    geom_bar(
      data = topOrigin1,
      aes(
        y = measured,
        x = reorder(CountryOriginName, measured)
      ),
      stat = "identity",
      fill = "#0072bc"
    ) +
    ggplot2::scale_x_discrete(labels = scales::label_wrap(45)) +
    coord_flip() +
    # scale_y_continuous( labels = scales::label_number(accuracy = 1,   scale_cut = cut_short_scale())) + ## Format axis number
    scale_y_continuous(
      labels = scales::label_percent(accuracy = 0.1, suffix = "%")
    ) +

    # facet_grid(.~ ctry_asy) +
    #  geom_hline(yintercept = 0, size = 1.1, colour = "#333333")   +
    labs(
      title = paste0(measurelabel, " | ", year, " in ", country_name_text),
      caption = "Source: UNHCR.org/refugee-statistics ",
      subtitle = paste0(
        "For top ",
        top_n_countries,
        " Countries of Origin ordered by ",
        order_bylabel
      ),
      x = " ",
      y = " "
    ) +
    theme_unhcr(
      grid = "Y",
      axis = "x",
      axis_title = "",
      font_size = 14
    ) +
    theme(
      # axis.text.x = element_blank(),
      # legend.position = "none",
      panel.grid.major.x = element_line(color = "#cbcbcb"),
      panel.grid.major.y = element_blank(),
      axis.text.y = element_text(size = category_font_size)
    ) ### changing grid line that should appear)

  return(rsdorigin)
}


## Source: plot_ctr_solution.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Plotting solutions within a country
#'
#' As part of UNHCR standard approach, there are mostly 3 types of durable solutions for Refugees:
#'  - Voluntary Repatriation in origin country
#'  - Naturalization in the host country
#'  - Resettlement in a third country
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param lag Number of year to used as comparison base
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param sol_type Vector of character values. Possible population type (e.g.:"NAT" "RST" "RET" "RDP")
#'
#' @param label_font_size Numeric value for label font size, default to 4
#' @param category_font_size Numeric value for axis text font size, default to 10
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text guide_axis facet_wrap vars
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#'
#' @examples
#' plot_ctr_solution(
#'   year = 2024,
#'   country_asylum_iso3c = "UGA",
#'   lag = 10,
#'   sol_type = c("NAT", "RST", "RET", "RDP"),
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
plot_ctr_solution <- function(
  year = 2024,
  lag = 10,
  country_asylum_iso3c = country_asylum_iso3c,
  sol_type,
  label_font_size = 4,
  category_font_size = 10
) {
  country_name_text <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::distinct(coa_name) |>
    dplyr::pull() |>
    head(1)

  Solution <- refugees::solutions |>
    dplyr::filter(coa_iso == country_asylum_iso3c & year > (year - lag)) |>
    tidyr::pivot_longer(
      cols = c(naturalisation, resettlement, returned_refugees, returned_idps),
      names_to = "Solution.type",
      values_to = "Value"
    ) |>
    dplyr::mutate(
      Solution.type.label = dplyr::case_when(
        Solution.type == "naturalisation" ~ "Naturalisation",
        Solution.type == "resettlement" ~ "Resettlement arrivals",
        Solution.type == "returned_refugees" ~ "Refugee returns",
        Solution.type == "returned_idps" ~ "IDP returns"
      )
    ) |>
    dplyr::filter(
      Solution.type.label %in%
        c(
          "Naturalisation",
          "Resettlement arrivals",
          "Refugee returns",
          "IDP returns"
        )
    ) |>
    dplyr::rename(Year = year) |>
    dplyr::mutate(Year = as.factor(Year)) |>
    dplyr::group_by(Year, Solution.type.label) |>
    dplyr::summarise(Value2 = sum(Value, na.rm = TRUE)) |>
    dplyr::mutate(
      valabel = ifelse(
        Value2 > 1000,
        paste(scales::label_number(
          accuracy = 0.1,
          scale_cut = scales::cut_short_scale()
        )(Value2)),
        as.character(Value2)
      )
    )

  ncat <- ifelse(
    nlevels(as.factor(Solution$Solution.type.label)) %in% c(2, 4),
    2,
    3
  )
  # levels(as.factor(solutions_long.asy$Solution.type.label))
  Solution$Solution.type.label <- factor(
    Solution$Solution.type.label,
    levels = c(
      "Naturalisation",
      "Resettlement arrivals",
      "Refugee returns",
      "IDP returns"
    )
  )

  if (nrow(Solution) == 0) {
    info <- paste0(
      "There's no recorded solutions \n in ",
      country_name_text,
      " for ",
      year
    )
    p <- ggplot() +
      annotate(
        stringr::str_wrap("text", 80),
        x = 1,
        y = 1,
        size = label_font_size,
        label = info
      ) +
      theme_void()
  } else {
    # Make plot
    p <- ggplot(Solution, aes(x = Year, y = Value2)) +
      geom_col(
        position = "identity",
        fill = unhcrthemes::unhcr_pal(n = 1, "pal_blue"),
        width = 0.7
      ) + # here we configure that it will be bar chart
      # scale_y_continuous( labels = scales::label_number(accuracy = 1,   scale_cut = cut_short_scale())) + ## Format axis number

      scale_y_continuous(
        labels = scales::label_number(
          accuracy = 1,
          scale_cut = cut_short_scale()
        ),
        expand = expansion(mult = c(0, 0.1))
      ) +
      scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +
      # xlim(c(year-lag, year +1)) +
      facet_wrap(
        vars(Solution.type.label),
        ncol = ncat,
        labeller = labeller(Solution.type.label = label_wrap_gen(20))
      ) +
      # geom_hline(yintercept = 0, size = 1.1, colour = "#333333") +
      theme_unhcr(font_size = 14) + ## Insert UNHCR Style
      theme(
        panel.grid.major.y = element_line(color = "#cbcbcb"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = category_font_size)
      ) + ### changing grid line that should appear
      ## and the chart labels
      labs(
        title = "What are the trends in terms of Solutions?",
        subtitle = paste0(
          "Data for Forcibly Displaced People across Borders as of ",
          year,
          " filtered for ",
          country_name_text
        ),
        x = "",
        y = "",
        caption = "Source: UNHCR.org/refugee-statistics.\n Resettlement  in this context this is the country of arrival  i.e. the country to which a refugee has been resettled \n Returns  in this context this is the country of departure  i.e. the country from which a refugee has voluntarily repatriated."
      )
  }

  return(p)
}


## Source: plot_ctr_solution_recognition.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Title
#'
#' Description

#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param lag Number of year to used as comparison base
#'
#' @import ForcedDisplacementStat
#' @importFrom unhcrthemes theme_unhcr
#' @importFrom ggtext element_markdown
#' @importFrom dplyr  desc select  filter mutate group_by filter summarise ungroup
#'               pull   full_join
#' @importFrom tidyr pivot_longer  pivot_wider
#' @importFrom ggbraid geom_braid
#' @importFrom lubridate ymd
#' @importFrom stringr str_wrap
#' @importFrom scales label_number cut_short_scale
#'
#' @return a ggplot2 object
#' @export
#' @examples
#' plot_ctr_solution_recognition(
#'   year = 2024,
#'   country_asylum_iso3c = "UGA",
#'   lag = 10
#' )
plot_ctr_solution_recognition <- function(
  year = 2024,
  lag = 10,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 4,
  category_font_size = 10
) {
  ctrylabel <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::distinct(coa_name) |>
    dplyr::pull() |>
    head(1)

  new_refugee_recognitions_and_refugee_like_increases <-
    refugees::asylum_decisions |>
    dplyr::filter(coa_iso == country_asylum_iso3c & year > (year - lag)) |>
    dplyr::mutate(Year = as.factor(year)) |>
    dplyr::group_by(Year, coa_iso) |>
    dplyr::summarize(
      new_refugee_recognitions_and_refugee_like_increases = sum(
        dec_recognized,
        na.rm = TRUE
      )
    ) |>
    dplyr::rename(CountryAsylumCode = coa_iso)

  refugee_solutions_naturalisation_resettlement_and_returns <-
    refugees::solutions |>
    dplyr::filter(coa_iso == country_asylum_iso3c & year > (year - lag)) |>
    tidyr::pivot_longer(
      cols = c(naturalisation, resettlement, returned_refugees),
      names_to = "Solution.type",
      values_to = "Value"
    ) |>
    dplyr::mutate(Year = as.factor(year)) |>
    dplyr::group_by(Year, coa_iso) |>
    dplyr::summarise(
      refugee_solutions_naturalisation_resettlement_and_returns = sum(
        Value,
        na.rm = TRUE
      )
    ) |>
    dplyr::rename(CountryAsylumCode = coa_iso)

  df_raw <-
    full_join(
      refugee_solutions_naturalisation_resettlement_and_returns,
      new_refugee_recognitions_and_refugee_like_increases,
      by = c("Year", "CountryAsylumCode")
    ) |>
    dplyr::mutate(Year = lubridate::ymd(Year, truncated = 2L))

  if (nrow(df_raw) == 0) {
    info <- paste0(
      "There's no recorded solutions or recognitions \n in ",
      ctrylabel,
      " for ",
      year
    )
    p <- ggplot() +
      annotate(
        stringr::str_wrap("text", 80),
        x = 1,
        y = 1,
        size = label_font_size,
        label = info
      ) +
      theme_void()
  } else {
    df_long <- df_raw |>
      dplyr::rename(
        new = new_refugee_recognitions_and_refugee_like_increases,
        sol = refugee_solutions_naturalisation_resettlement_and_returns
      ) |>
      dplyr::mutate(year = lubridate::ymd(Year, truncated = 2L)) |>
      tidyr::pivot_longer(cols = new:sol)

    df_wide <-
      tidyr::pivot_wider(df_long, names_from = name, values_from = value)

    p <-
      ggplot() +
      geom_ribbon(
        data = df_wide,
        aes(
          x = year,
          ymin = pmin(new, sol),
          ymax = pmax(new, sol),
          fill = new < sol
        ),
        alpha = 0.3
      ) +
      geom_line(
        data = df_long,
        aes(x = year, y = value, color = name),
        linewidth = .75
      ) +
      scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
      scale_y_continuous(
        labels = scales::label_number(scale_cut = scales::cut_short_scale()),
        limits = c(0, NA),
        expand = expansion(c(0, 0.02))
      ) +
      scale_color_manual(values = c("#0072bc", "#00B398")) +
      scale_fill_manual(values = c("#0072bc", "#00B398")) +
      labs(
        title = stringr::str_wrap(
          "How do <span style='color:#0072bc;'>refugee recognitions<sup>a</sup></span> compare with available <span style='color:#00B398;'>solutions<sup>b</sup></span>?",
          80
        ),
        subtitle = paste0("Data  for ", ctrylabel, " as of ", year),
        caption = "Source: UNHCR.org/refugee-statistics \n (a) Refugee recognition refers to the legal process through which an individual is granted refugee status by a country's government.\n (b) Refugee solutions includes returns, i.e departure to country of origin, resettlement to a third country and naturalization."
      ) +
      unhcrthemes::theme_unhcr(
        font_size = 14,
        legend = FALSE,
        axis_title = FALSE,
        grid = "Yy"
      ) +
      theme(
        ## used to display part of the title in different colors
        plot.title = ggtext::element_markdown()
      )
  }

  return(p)
}


## Source: plot_ctr_treemap.R

# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Tree map of Population Groups within a country
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param label_font_size Numeric value for label font size, default to 12
#' @param category_font_size Numeric value for axis text font size, default to 14
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#'
#' @examples
#' #
#' plot_ctr_treemap(
#'   year = 2024,
#'   country_asylum_iso3c = "USA",
#'   label_font_size = 12,
#'   category_font_size = 14
#' )
plot_ctr_treemap <- function(
  year = 2024,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 12,
  category_font_size = 14
) {
  dict_pop_type_name <- c(
    "refugees" = "Refugees",
    "returned_refugees" = "Returned refugees",
    "asylum_seekers" = "Asylum-seekers",
    "idps" = "Internally displaced persons",
    "returned_idps" = "Returned idps",
    "oip" = "Other people in need of international protection",
    "stateless" = "Stateless people",
    "ooc" = "Others of concern to UNHCR",
    "hst" = "Host community"
  )

  country_name_text <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::slice(1) |>
    dplyr::pull(coa_name)

  datatree <- refugees::population |>
    dplyr::filter(
      year == !!year,
      coa_iso == country_asylum_iso3c
    ) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::select(-c(year)) |>
    dplyr::group_by(coa_name, population_type) |>
    dplyr::summarise(
      dplyr::across(tidyselect::where(is.numeric), ~ sum(.x, na.rm = TRUE)),
      .groups = "drop"
    ) |>
    dplyr::mutate(
      population_type_name = stringr::str_replace_all(
        population_type,
        pattern = dict_pop_type_name
      )
    )

  p <- ggplot2::ggplot() +
    treemapify::geom_treemap(
      data = datatree,
      ggplot2::aes(
        area = value,
        fill = population_type
      )
    ) +
    treemapify::geom_treemap_text(
      data = datatree,
      ggplot2::aes(
        area = value,
        fill = population_type,
        label = paste0(
          round(100 * value / sum(value), 1),
          "%\n",
          stringr::str_wrap(population_type_name, 20)
        )
      ),
      colour = "white",
      place = "centre",
      size = label_font_size
    ) +
    ggplot2::scale_fill_manual(
      values = c(
        "idps" = "#32C189",
        # "VDA"="#EF4A60",
        "oip" = "#D25A45",
        "asylum_seekers" = "#6CD8FD",
        "refugees" = "#0072BC",
        "ooc" = "#bfbfbf",
        "stateless" = "#FFC740"
      )
    ) +
    unhcrthemes::theme_unhcr(
      font_size = 14,
      grid = "Y",
      axis = "x",
      axis_title = "y",
      legend = FALSE
    ) +
    ggplot2::theme(legend.position = "none") +
    ## and the chart labels

    ggplot2::labs(
      title = paste0("Population of Concern in ", country_name_text),
      subtitle = paste0(
        " As of ",
        year,
        ", a total of ",
        format(round(sum(datatree$value), -3), big.mark = ","),
        " Individuals"
      ),
      x = "",
      y = "",
      caption = "Source: UNHCR.org/refugee-statistics"
    )

  return(p)
}

# ========================================================
# PLAYGROUND EXECUTION
# ========================================================

# Parameters
year <- 2024
country_asylum_iso3c <- "COL"
country_origin_iso3c <- "VEN" # Venezuela

print("----------------------------------------------------------------")
print(paste(
  "Testing plots for Year:",
  year,
  " | Asylum:",
  country_asylum_iso3c,
  " | Origin:",
  country_origin_iso3c
))
print("----------------------------------------------------------------")

run_test <- function(func, name, ...) {
  cat(paste0("\nTesting ", name, "... "))
  tryCatch(
    {
      p <- func(...)
      if (inherits(p, "ggplot") || inherits(p, "grob")) {
        print(p)
        cat("SUCCESS\n")
      } else {
        cat("SUCCESS (No plot returned or invisible)\n")
      }
    },
    error = function(e) {
      cat(paste0("FAILED: ", e, "\n"))
    }
  )
}

# 1. Asylum
run_test(
  plot_ctr_asylum,
  "plot_ctr_asylum",
  year = year,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 4,
  lag = 5,
  category_font_size = 15,
  legend_font_size = 12
)

# 2. Destination (Origin based)
run_test(
  plot_ctr_destination,
  "plot_ctr_destination",
  year = year,
  country_origin_iso3c = country_origin_iso3c,
  label_font_size = 5,
  category_font_size = 15
)

# 3. Diff in Pop Groups
run_test(
  plot_ctr_diff_in_pop_groups,
  "plot_ctr_diff_in_pop_groups",
  year = year,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 5,
  category_font_size = 8
)

# 4. Disp Migrant
# run_test(
#   plot_ctr_disp_migrant,
#   "plot_ctr_disp_migrant",
#   year = year,
#   country_asylum_iso3c = country_asylum_iso3c,
#   label_font_size = 4,
#   category_font_size = 10
# )

# 5. Key Figures
run_test(
  plot_ctr_keyfig,
  "plot_ctr_keyfig",
  year = year,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 4,
  category_font_size = 10
)

# 6. Location
run_test(
  plot_ctr_location,
  "plot_ctr_location",
  year = year,
  country_origin_iso3c = country_origin_iso3c, # Changed from asylum to origin
  pop_type = c("REF", "ASY", "OIP"),
  label_font_size = 4,
  category_font_size = 10
)

# 7. Origin History
run_test(
  plot_ctr_origin_history,
  "plot_ctr_origin_history",
  year = year,
  lag = 5,
  country_asylum_iso3c = country_asylum_iso3c,
  category_font_size = 10,
  legend_font_size = 10
)

# 8. Origin Recognition (Origin based)
run_test(
  plot_ctr_origin_recognition,
  "plot_ctr_origin_recognition",
  year = year,
  country_origin_iso3c = country_origin_iso3c,
  label_font_size = 4,
  category_font_size = 10
)
#
# # 9. Pop Type Abs
run_test(
  plot_ctr_population_type_abs,
  "plot_ctr_population_type_abs",
  year = year,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 4,
  category_font_size = 10
)

# 10. Pop Type Per Year
run_test(
  plot_ctr_population_type_per_year,
  "plot_ctr_population_type_per_year",
  year = year,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 4,
  category_font_size = 10,
  legend_font_size = 10
)

# 11. Pop Type Perc
run_test(
  plot_ctr_population_type_perc,
  "plot_ctr_population_type_perc",
  year = year,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 4,
  category_font_size = 10
)

# 12. Process
run_test(
  plot_ctr_process,
  "plot_ctr_process",
  year = year,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 4,
  category_font_size = 10
)

# 13. Processing Time
run_test(
  plot_ctr_processing_time,
  "plot_ctr_processing_time",
  year = year,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 4,
  category_font_size = 10,
  legend_font_size = 10
)

# 14. Pyramid
run_test(
  plot_ctr_pyramid,
  "plot_ctr_pyramid",
  year = year,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 4,
  category_font_size = 10
)

# 15. Recognition
run_test(
  plot_ctr_recognition,
  "plot_ctr_recognition",
  year = year,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 4,
  category_font_size = 10
)

# 16. Solution
run_test(
  plot_ctr_solution,
  "plot_ctr_solution",
  year = year,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 4,
  category_font_size = 10
)

# 17. Solution Recognition
run_test(
  plot_ctr_solution_recognition,
  "plot_ctr_solution_recognition",
  year = year,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 4,
  category_font_size = 10
)

# 18. Treemap
run_test(
  plot_ctr_treemap,
  "plot_ctr_treemap",
  year = year,
  country_asylum_iso3c = country_asylum_iso3c,
  label_font_size = 12,
  category_font_size = 14
)

print("Done.")
