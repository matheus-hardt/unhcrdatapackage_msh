# WARNING - Generated by {fusen} from dev/dev_plot_Region.Rmd: do not edit by hand # nolint: line_length_linter.

# Note: Chord diagram is base graphics, styling is limited. Kept as is.

#' Plot Regional Origin Destination
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value including the UNHCR region
#' @export
#' @examples
#' plot_reg_origin_dest(
#'     year = 2024,
#'     region = "The Americas"
#' )
plot_reg_origin_dest <- function(year = 2024, region = "The Americas") {
    chords <- refugees::population |>
        dplyr::filter(year == !!year) |>
        dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
        dplyr::filter(unhcr_region == region) |>
        dplyr::mutate(
            refugees = tidyr::replace_na(refugees, 0),
            asylum_seekers = tidyr::replace_na(asylum_seekers, 0),
            oip = tidyr::replace_na(oip, 0),
            total = refugees + asylum_seekers + oip
        ) |>
        dplyr::group_by(coo_name, coa_name) |>
        dplyr::summarise(total = sum(total, na.rm = TRUE), .groups = "drop") |>
        dplyr::mutate(
            CountryAsylumName = forcats::fct_lump_prop(coa_name, prop = .02, w = total),
            CountryOriginName = forcats::fct_lump_prop(coo_name, prop = .02, w = total)
        ) |>
        dplyr::group_by(CountryOriginName, CountryAsylumName) |>
        dplyr::summarize(total = sum(total), .groups = "drop") |>
        dplyr::mutate(
            CountryOriginName = stringr::str_replace(CountryOriginName, " \\(Bolivarian Republic of\\)", ""),
            CountryAsylumName = stringr::str_replace(CountryAsylumName, " \\(Bolivarian Republic of\\)", ""),
            CountryOriginName = stringr::str_replace(CountryOriginName, " \\(Plurinational State of\\)", ""),
            CountryAsylumName = stringr::str_replace(CountryAsylumName, " \\(Plurinational State of\\)", ""),
            CountryOriginName = stringr::str_replace(CountryOriginName, "United States of America", "USA"),
            CountryAsylumName = stringr::str_replace(CountryAsylumName, "United States of America", "USA")
        ) |>
        dplyr::rename(
            origin = CountryOriginName,
            destination = CountryAsylumName,
            value = total
        ) |>
        dplyr::filter(origin != destination, value > 0)

    chords <- as.data.frame(chords)

    if (nrow(chords) == 0) {
        message(paste("No significant population movement found for", region, "in", year))
        return(invisible(NULL))
    }

    n_sectors <- length(unique(c(chords$origin, chords$destination)))
    if (n_sectors < 2) {
        message(paste("Insufficient unique origins/destinations for", region))
        return(invisible(NULL))
    }

    old_par <- graphics::par(no.readonly = TRUE)
    on.exit(graphics::par(old_par), add = TRUE)
    circlize::circos.clear()
    graphics::par(family = "Lato")

    circlize::chordDiagram(
        chords,
        directional = 1,
        direction.type = c("diffHeight", "arrows"),
        diffHeight = 0.02,
        link.arr.length = 0.1,
        link.arr.width = 0.1,
        link.arr.type = "big.arrow",
        annotationTrack = "grid",
        preAllocateTracks = list(track.height = 0.15)
    )

    circlize::circos.track(
        track.index = 1,
        panel.fun = function(x, y) {
            circlize::circos.text(
                circlize::CELL_META$xcenter,
                circlize::CELL_META$ylim[1],
                circlize::CELL_META$sector.index,
                facing = "clockwise",
                niceFacing = TRUE,
                adj = c(0, 0.5)
            )
        },
        bg.border = NA
    )

    graphics::title(
        main = "Movement of Forcibly Displaced Population",
        sub = paste0("In ", region, " as of ", year),
        cex.main = 1.5
    )
    circlize::circos.clear()
    return(invisible(NULL))
}
