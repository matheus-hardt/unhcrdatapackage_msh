# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Display A Chart with Refugee Recognition Rate for nationals from a specific country
#'
#' In the absence of an internationally agreed methodology for calculating recognition rates,
#'  UNHCR uses two rates to compute the proportion of refugee claims accepted during the year:
#'
#'   * The Refugee Recognition Rate divides the number of asylum-seekers granted Convention refugee
#'   status by the total number of accepted (Convention and, where relevant, complementary
#'   protection) and rejected cases (aka substantive decision).
#'
#'   * The Total Recognition Rate divides the number of asylum-seekers granted Convention
#'    refugee status and / or complementary form of protection by the total number
#'    of accepted (Convention and, where relevant, complementary protection) and
#'     rejected cases.
#'
#' Non-substantive decisions are, to the extent possible, excluded from both
#' calculations. For the purpose of international comparability,  UNHCR only
#' uses these two recognition rates and does not report nationally calculated rates.
#'
#'      See https://www.unhcr.org/4ce531e09.pdf
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_origin_iso3c Character value with the ISO-3 character code
#'                             of the Country of Origin
#' @param top_n_countries Numeric value of number of main countries that the graph
#'                        should display
#' @param measure this can be either:
#'            * RefugeeRecognitionRate
#'            * TotalRecognitionRate
#' @param order_by this can be either:
#'            * Recognized
#'            * ComplementaryProtection
#'            * TotalDecided
#'
#' @param label_font_size Numeric value for label font size, default to 4
#' @param category_font_size Numeric value for axis text font size, default to 10
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text guide_axis facet_wrap vars
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty pretty_breaks
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer
#' @importFrom unhcrthemes theme_unhcr  scale_fill_unhcr_d
#'
#' @return a ggplot2 object
#'
#' @export
#' @examples
#' plot_ctr_origin_recognition(
#'   year = 2024,
#'   country_origin_iso3c = "VEN",
#'   top_n_countries = 10,
#'   measure = "RefugeeRecognitionRate",
#'   order_by = "TotalDecided",
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
#' plot_ctr_origin_recognition(
#'   year = 2024,
#'   country_origin_iso3c = "VEN",
#'   top_n_countries = 10,
#'   measure = "RefugeeRecognitionRate",
#'   order_by = "TotalDecided"
#' )
plot_ctr_origin_recognition <- function(
  year = 2024,
  country_origin_iso3c,
  top_n_countries = 10,
  measure = "RefugeeRecognitionRate",
  order_by = "TotalDecided",
  label_font_size = 4,
  category_font_size = 10
) {
  country_name_text <- refugees::population |>
    dplyr::filter(coo_iso == country_origin_iso3c) |>
    dplyr::distinct(coo_name) |>
    dplyr::pull() |>
    head(1)

  measurelabel <-
    dplyr::case_when(
      measure == "RefugeeRecognitionRate" ~ "Refugee Recognition Rate",
      measure == "TotalRecognitionRate" ~ "Total Recognition Rate"
    )

  order_bylabel <-
    dplyr::case_when(
      order_by == "Recognized" ~ "Recognized Refugee Status Decisions",
      order_by ==
        "ComplementaryProtection" ~ "Complementary Protection Decisions",
      order_by ==
        "TotalDecided" ~ "Total Decision (independently of the outcome)"
    )

  topAsylum <- refugees::asylum_decisions |>
    dplyr::filter(coo_iso == country_origin_iso3c & year == year) |>
    dplyr::mutate(DecisionsAveragePersonsPerCase = 1) |>
    dplyr::rename(CountryAsylumName = coa_name) |>
    dplyr::group_by(CountryAsylumName) |>
    dplyr::summarize(
      Recognized = sum(dec_recognized, na.rm = TRUE),
      ComplementaryProtection = sum(dec_other, na.rm = TRUE),
      TotalDecided = sum(dec_total, na.rm = TRUE)
    ) |>
    dplyr::mutate(
      RefugeeRecognitionRate = (Recognized) / TotalDecided,
      TotalRecognitionRate = (Recognized + ComplementaryProtection) /
        TotalDecided
    )

  topAsylum1 <- topAsylum |>
    dplyr::mutate(measured = .data[[measure]]) |>
    dplyr::mutate(order_by = .data[[order_by]]) |>
    dplyr::arrange(dplyr::desc(order_by)) |>
    head(top_n_countries) |>
    dplyr::mutate(
      measuredRound = scales::label_percent(accuracy = 0.1, suffix = "%")(
        measured
      )
    )

  rsdAsylum <- ggplot2::ggplot() +
    ggplot2::geom_col(
      data = topAsylum1,
      ggplot2::aes(
        y = measured,
        x = stats::reorder(CountryAsylumName, measured)
      ),
      fill = unhcrthemes::unhcr_pal(n = 1, "pal_blue")
    ) +
    ## Position label differently in the bar in white - outside bar in black
    ggplot2::geom_text(
      data = subset(
        topAsylum1,
        measured < max(measured) / 1.5
      ),
      ggplot2::aes(
        y = measured,
        x = stats::reorder(CountryAsylumName, measured),
        label = measuredRound
      ),
      hjust = -0.1,
      vjust = 0.5,
      colour = "black",
      size = label_font_size
    ) +
    ggplot2::geom_text(
      data = subset(
        topAsylum1,
        measured >= max(measured) / 1.5
      ),
      ggplot2::aes(
        y = measured,
        x = stats::reorder(CountryAsylumName, measured),
        label = measuredRound
      ),
      hjust = 1.1,
      vjust = 0.5,
      colour = "white",
      size = label_font_size
    ) +
    ggplot2::coord_flip() +
    ggplot2::scale_y_continuous(
      expand = ggplot2::expansion(c(0, 0.1)),
      labels = scales::label_percent(accuracy = 0.1, suffix = "%")
    ) +
    ggplot2::labs(
      title = paste0(
        measurelabel,
        " | ",
        year,
        " for Nationals from ",
        country_name_text
      ),
      subtitle = paste0(
        "For top ",
        top_n_countries,
        " Countries of Asylum ordered by ",
        order_bylabel
      ),
      x = "",
      y = "",
      caption = "Source: UNHCR.org/refugee-statistics "
    ) +
    ggplot2::scale_x_discrete(labels = scales::label_wrap(20)) +
    unhcrthemes::theme_unhcr(
      font_size = 14,
      grid = FALSE,
      axis = "y",
      axis_title = FALSE,
      axis_text = "y"
    ) +
    ggplot2::theme(
      axis.text.y = ggplot2::element_text(size = category_font_size),
      panel.grid.major.y = ggplot2::element_blank(),
      plot.margin = ggplot2::margin(5, 5, 5, 30)
    )

  return(rsdAsylum)
}
