# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Asylum Processing
#'
#' Displaying Asylum processing
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param country_asylum_iso3c Character value with the ISO-3 character code of the Country of Asylum
#' @param otherprop value set by default to .02 - used to merge origin as "Other"
#'
#'
#' @param label_font_size Numeric value for label font size, default to 4
#' @param category_font_size Numeric value for axis text font size, default to 10
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  scale_color_manual scale_colour_manual
#'             geom_text guide_axis facet_wrap vars theme_void
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace str_wrap
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join rename count
#' @importFrom tidyr pivot_longer
#' @importFrom forcats fct_relevel
#' @importFrom  ggforce geom_parallel_sets geom_parallel_sets_axes
#'                  geom_parallel_sets_labels gather_set_data
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return a ggplot2 object
#'
#' @export
#' @examples
#' plot_ctr_process(
#'   year = 2024,
#'   country_asylum_iso3c = "BOL",
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
#'
#' plot_ctr_process(
#'   year = 2024,
#'   country_asylum_iso3c = "CHL",
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
#'
#'
#' plot_ctr_process(
#'   year = 2024, country_asylum_iso3c = "USA",
#'   otherprop = .02,
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
#'
#' plot_ctr_process(
#'   year = 2024, country_asylum_iso3c = "USA",
#'   otherprop = .04,
#'   label_font_size = 4,
#'   category_font_size = 10
#' )
#' plot_ctr_process(year = 2024, country_asylum_iso3c = "BOL")
#'
#' plot_ctr_process(year = 2024, country_asylum_iso3c = "CHL")
#'
#'
#' plot_ctr_process(
#'   year = 2024, country_asylum_iso3c = "USA",
#'   otherprop = .02
#' )
#'
#' plot_ctr_process(
#'   year = 2024, country_asylum_iso3c = "USA",
#'   otherprop = .04
#' )
plot_ctr_process <- function(
  year = 2024,
  country_asylum_iso3c,
  otherprop = .02,
  label_font_size = 4,
  category_font_size = 10
) {
  country_name_text <- refugees::population |>
    dplyr::filter(coa_iso == country_asylum_iso3c) |>
    dplyr::distinct(coa_name) |>
    dplyr::pull() |>
    head(1)

  links <- refugees::asylum_decisions |>
    dplyr::filter(year == year & coa_iso == country_asylum_iso3c) |>
    dplyr::rename(CountryOriginName = coo_name) |>
    dplyr::mutate(
      CountryOriginName = forcats::fct_lump_prop(
        CountryOriginName,
        prop = otherprop,
        w = dec_total
      )
    ) |>
    tidyr::pivot_longer(
      cols = c(dec_recognized, dec_other, dec_rejected, dec_closed),
      names_to = "Decision.output",
      values_to = "value"
    ) |>
    dplyr::mutate(
      Decision.output = dplyr::case_when(
        Decision.output == "dec_recognized" ~ "Recognized",
        Decision.output == "dec_other" ~ "Complementary\nProtection",
        Decision.output == "dec_rejected" ~ "Rejected",
        Decision.output == "dec_closed" ~ "Otherwise\nClosed"
      ),
      ProcedureName = dplyr::case_when(
        dec_level == "G" ~ "Government",
        dec_level == "U" ~ "UNHCR",
        dec_level == "J" ~ "Joint",
        TRUE ~ "Unknown"
      )
    ) |>
    dplyr::group_by(CountryOriginName, ProcedureName, Decision.output) |>
    dplyr::summarise(n = sum(value, na.rm = TRUE))
  # levels(links$Decision.output)

  ## Case no record outut a ggplot2 object with anotation
  if (nrow(links) == 0) {
    info <- paste0(
      "There's no recorded Asylum Decisions \n in ",
      country_name_text,
      " for ",
      year
    )
    p <- ggplot() +
      annotate(
        stringr::str_wrap("text", 80),
        x = 1,
        y = 1,
        size = 11,
        label = info
      ) +
      theme_void()
  } else {
    ## summarize data
    # Rename columns for better display
    links_renamed <- links |>
      dplyr::rename(
        `Country of Origin` = CountryOriginName,
        `Procedure` = ProcedureName,
        `Decision output` = Decision.output
      ) |>
      dplyr::mutate(
        `Country of Origin` = stringr::str_wrap(`Country of Origin`, width = 20)
      )

    flow_table <- links_renamed |>
      ggforce::gather_set_data(
        x = c("Country of Origin", "Procedure", "Decision output")
      )

    flow_table[["Decision output"]] <- factor(
      flow_table[["Decision output"]],
      levels = c(
        "Rejected",
        "Complementary\nProtection",
        "Recognized",
        "Otherwise\nClosed"
      )
    )
    ## plot your dataset
    ## on the x axis is the start and end causes
    ## gather_set_data generates an ID for each possible combination
    ## splitting by y gives the possible start/end combos
    ## value as n gives it as counts (could also be changed to proportion)
    p <- ggplot(
      flow_table,
      aes(x, id = id, split = y, value = n)
    ) +
      ## colour lines by sex
      ggforce::geom_parallel_sets(
        aes(fill = `Decision output`),
        alpha = 0.5,
        axis.width = 0.2
      ) +
      ## fill in the label boxes grey
      ggforce::geom_parallel_sets_axes(
        axis.width = 0.15,
        fill = "grey80",
        color = "grey80"
      ) +
      ## change text colour and angle (needs to be adjusted)
      ggforce::geom_parallel_sets_labels(
        color = "black",
        angle = 0,
        size = label_font_size
      ) +
      ## adjusted y and x axes (probably needs more vertical space)
      scale_x_discrete(
        labels = scales::label_wrap(25),
        name = NULL,
        expand = c(0, 0.2)
      ) +
      theme_unhcr(
        font_size = 14,
        grid = FALSE
      ) +
      ## remove axis labels
      theme(
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "none", # move legend to bottom
        legend.title = element_blank(), # remove title
        axis.text.x = element_text(size = category_font_size)
      ) +
      labs(
        title = "Refugee Status Determination Decisions",
        subtitle = paste0(
          country_name_text,
          ", ",
          format(sum(links$n), big.mark = ","),
          " decisions recorded in ",
          year
        ),
        x = NULL,
        y = NULL,
        caption = "Source: UNHCR.org/refugee-statistics"
      )
  }
  return(p)
}
