# WARNING - Generated by {fusen} from dev/dev_plot_Region.Rmd: do not edit by hand # nolint: line_length_linter.

#' Plot Regional Population Type per Year
#'
#' @param year Numeric value of the year (for instance 2020)
#' @param region Character value including the UNHCR region
#' @param lag Number of year to used as comparison base
#' @param pop_type Vector of character values. Possible population type
#' @param label_font_size Numeric value for label font size
#' @param category_font_size Numeric value for axis text font size
#' @param legend_font_size Numeric value for legend font size
#' @export
#' @examples
#' plot_reg_population_type_per_year(
#'     year = 2024,
#'     region = "The Americas",
#'     label_font_size = 4,
#'     category_font_size = 10,
#'     legend_font_size = 10
#' )
plot_reg_population_type_per_year <- function(year = 2024,
                                              region = "The Americas",
                                              lag = 5,
                                              pop_type = c("REF", "ASY", "IDP", "OIP", "STA", "OOC"),
                                              label_font_size = 4,
                                              category_font_size = 10,
                                              legend_font_size = 10) {
    if (length(pop_type) == 1) {
        pop_type <- pop_type
    } # Redundant but safe

    pop_type_label_dict <- c(
        "REF" = "Refugees",
        "ASY" = "Asylum-seekers",
        "IDP" = "Internally displaced persons",
        "OIP" = "Other people in need of international protection",
        "STA" = "Stateless people",
        "OOC" = "Others of concern to UNHCR",
        "HST" = "Host community"
    )

    df <- refugees::population |>
        dplyr::filter(year >= (!!year - lag) & year <= !!year) |>
        dplyr::mutate(unhcr_region = countrycode::countrycode(coa_iso, "iso3c", "unhcr.region")) |>
        dplyr::filter(unhcr_region == region) |>
        tidyr::pivot_longer(
            cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
            names_to = "population_type",
            values_to = "value"
        ) |>
        dplyr::mutate(
            population_type_label = dplyr::case_when(
                population_type == "refugees" ~ "REF",
                population_type == "asylum_seekers" ~ "ASY",
                population_type == "idps" ~ "IDP",
                population_type == "oip" ~ "OIP",
                population_type == "stateless" ~ "STA",
                population_type == "ooc" ~ "OOC",
                population_type == "hst" ~ "HST",
                TRUE ~ "Other"
            )
        ) |>
        dplyr::filter(population_type_label %in% pop_type) |>
        dplyr::group_by(year, population_type_label) |>
        dplyr::summarise(value = sum(value, na.rm = TRUE), .groups = "drop") |>
        dplyr::mutate(population_type_name = dplyr::recode(population_type_label, !!!pop_type_label_dict))

    p <- ggplot2::ggplot(df, ggplot2::aes(x = year, y = value, colour = population_type_label)) +
        ggplot2::geom_line(linewidth = 1) +
        ggplot2::geom_hline(yintercept = 0, linewidth = 1.1, colour = "#333333") +
        ggplot2::scale_y_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
        ggplot2::xlim(c(year - lag, year + 1)) +
        # Use standardized manual colors if possible, or unhcr_d
        ggplot2::scale_color_manual(
            values = cols_poptype_abbr,
            labels = pop_type_label_dict
        ) +
        # ggplot2::geom_label(
        #     data = df |> dplyr::filter(year == max(year)),
        #     ggplot2::aes(
        #         x = year + .5,
        #         y = value,
        #         label = population_type_name,
        #         color = population_type_label
        #     ),
        #     hjust = 0,
        #     vjust = 0.5,
        #     fill = "white",
        #     linewidth = NA,
        #     family = "Lato",
        #     size = label_font_size
        # ) +
        unhcrthemes::theme_unhcr(
            grid = "Y",
            axis = "x",
            axis_title = "y",
            font_size = 14
        ) +
        ggplot2::theme(
            legend.position = "top",
            legend.justification = "left",
            panel.grid.major.y = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.x = ggplot2::element_blank(),
            panel.grid.minor = ggplot2::element_blank(),
            axis.text.x = ggplot2::element_text(size = category_font_size),
            legend.text = ggplot2::element_text(size = legend_font_size),
            legend.title = ggplot2::element_blank()
        ) +
        ggplot2::labs(
            title = paste0("Evolution of Population of Concern in ", region),
            subtitle = paste0("Evolution in the past ", lag, " years"),
            x = "",
            y = "",
            caption = "Source: UNHCR.org/refugee-statistics"
        )

    return(p)
}
