# WARNING - Generated by {fusen} from dev/dev_plot_Country.Rmd: do not edit by hand # nolint: line_length_linter.

#' Map of Destination Countries
#'
#' @param year Numeric value of the year  (for instance 2022).
#'             If the data is not yet available for that year (aka still in the mid year reporting stage),
#'              it will automatically fall back on the previous year
#'
#' @param country_origin_iso3c Character value with the ISO-3 character code of the Country of Origin
#' @param pop_type Vector of character values. Possible population type (e.g.: REF, IDP, ASY, OIP, OOC, STA)
#' @param mapbackground can be "osm" (default), "stamen-toner" , "stamen-terrain","stamen-watercolor".
#'            Other mapbackground requires an API key and were not considered
#'
#' @param label_font_size Numeric value for label font size, default to 4
#' @param category_font_size Numeric value for axis text font size, default to 10
#'
#' @importFrom ggplot2  ggplot  aes  coord_flip   element_blank element_line
#'             element_text expansion geom_bar geom_col geom_hline unit stat_summary
#'             geom_label geom_text labs  position_stack  geom_point
#'             scale_color_manual scale_colour_manual
#'             scale_size_continuous element_rect
#'             geom_text .pt theme_void
#'             scale_fill_manual scale_x_continuous scale_x_discrete  scale_y_continuous   sym theme
#' @importFrom utils  head
#' @importFrom tidyselect where
#' @importFrom stringr  str_replace str_detect  str_glue
#' @importFrom scales cut_short_scale label_percent label_number breaks_pretty
#' @importFrom stats  reorder aggregate  setNames
#' @importFrom dplyr  desc select  case_when lag mutate group_by filter summarise ungroup
#'               pull distinct n arrange across slice left_join
#' @importFrom tidyr pivot_longer pivot_wider
#' @importFrom ggspatial geom_sf coord_sf
#' @importFrom sf st_as_sf st_set_crs st_bbox st_break_antimeridian st_make_valid
#' @importFrom rnaturalearth ne_countries
#' @import rnaturalearthdata
#' @importFrom ggrepel geom_label_repel
#' @importFrom grDevices hcl.colors
#' @importFrom OpenStreetMap openmap openproj autoplot.OpenStreetMap
#' @importFrom unhcrthemes theme_unhcr scale_fill_unhcr_c
#'
#' @return a ggplot2 object
#'
#' @export
#'
#' @examples
#' # plot_ctr_location(year = 2024,
#' #                  country_origin_iso3c = "COL",
#' #                  pop_type = c("ASY", "REF", "OIP"))
#' #
#' # plot_ctr_location(year = 2024,
#' #                  country_origin_iso3c = "COL",
#' #                  pop_type = c("IDP"))
#' #
#' # plot_ctr_location(year = 2024,
#' #                  country_origin_iso3c = "CAN",
#' #                  pop_type = c("ASY", "REF", "OIP"))
#' #
#' # plot_ctr_location(year = 2024,
#' #                  country_origin_iso3c = "MEX",
#' #                  pop_type = c("ASY", "REF", "OIP"),
#' #                  label_font_size = 4,
#' #                  category_font_size = 10)
#' # plot_ctr_location(year = 2024,
#' #                  country_asylum_iso3c = "COL",
#' #                  pop_type = c("ASY", "REF", "OIP"))
#' #
#' # plot_ctr_location(year = 2024,
#' #                  country_asylum_iso3c = "COL",
#' #                  pop_type = c("IDP"))
#' #
#' # plot_ctr_location(year = 2024,
#' #                  country_asylum_iso3c = "CAN",
#' #                  pop_type = c("ASY", "REF", "OIP"))
#' #
#' # plot_ctr_location(year = 2024,
#' #                  country_asylum_iso3c = "MEX",
#' #                  pop_type = c("ASY", "REF", "OIP"))
plot_ctr_location <- function(
  year,
  country_origin_iso3c,
  pop_type,
  mapbackground = "osm",
  label_font_size = 4,
  category_font_size = 10
) {
  # Get country name for Origin
  country_name_text <- refugees::population |>
    dplyr::filter(coo_iso == country_origin_iso3c) |>
    dplyr::distinct(coo_name) |>
    dplyr::pull() |>
    head(1)

  if (length(country_name_text) == 0) {
    country_name_text <- country_origin_iso3c
  }

  dict_pop_type_name <- c(
    "REF" = "Refugees",
    "RETURNED_REF" = "Returnees",
    "ASY" = "Asylum-seekers",
    "IDP" = "Internally displaced persons",
    "RETURNED_IDP" = "Returned idps",
    "OIP" = "Other people in need of international protection",
    "STA" = "Stateless people",
    "OOC" = "Others of concern to UNHCR",
    "HST" = "Host community"
  )

  # Prepare Data: Filter by Origin and summarize by Asylum
  data <- refugees::population |>
    dplyr::filter(
      year == !!year,
      coo_iso == country_origin_iso3c
    ) |>
    tidyr::pivot_longer(
      cols = c(refugees, asylum_seekers, idps, oip, stateless, ooc, hst),
      names_to = "population_type",
      values_to = "value"
    ) |>
    dplyr::mutate(
      population_type = dplyr::case_when(
        population_type == "refugees" ~ "REF",
        population_type == "asylum_seekers" ~ "ASY",
        population_type == "idps" ~ "IDP",
        population_type == "oip" ~ "OIP",
        population_type == "stateless" ~ "STA",
        population_type == "ooc" ~ "OOC",
        population_type == "hst" ~ "HST",
        TRUE ~ population_type
      )
    ) |>
    dplyr::filter(population_type %in% pop_type) |>
    dplyr::group_by(coa_iso) |>
    dplyr::summarise(value = sum(value, na.rm = TRUE)) |>
    dplyr::ungroup()

  # Get World Map
  world_sf <- rnaturalearth::ne_countries(
    scale = "medium",
    returnclass = "sf"
  ) |>
    dplyr::filter(iso_a3 != "ATA") |> # Exclude Antarctica for better view
    sf::st_break_antimeridian(lon_0 = 0) |>
    sf::st_make_valid()

  # Join Data to Map
  map_data <- world_sf |>
    dplyr::left_join(data, by = c("iso_a3" = "coa_iso"))

  # Plot
  p <- ggplot2::ggplot() +
    ggplot2::geom_sf(
      data = map_data,
      ggplot2::aes(fill = value),
      color = "white",
      size = 0.1
    ) +
    # Highlight Origin Country
    ggplot2::geom_sf(
      data = world_sf |> dplyr::filter(iso_a3 == country_origin_iso3c),
      fill = "#333333", # Dark grey for origin
      color = "white",
      size = 0.2
    ) +
    ggplot2::coord_sf(
      crs = "+proj=robin",
      datum = NA
    ) +
    unhcrthemes::scale_fill_unhcr_c(
      palette = "pal_blue",
      name = "Population",
      labels = scales::label_comma()
    ) +
    ggplot2::labs(
      title = paste0(
        "Where are people from ",
        country_name_text,
        "?"
      ),
      subtitle = paste0(
        "Destination countries of ",
        paste(dict_pop_type_name[pop_type], collapse = ", "),
        " from ",
        country_name_text,
        " as of ",
        year
      ),
      caption = "Source: UNHCR.org/refugee-statistics.\nOrigin country highlighted in dark grey.",
      x = NULL,
      y = NULL
    ) +
    unhcrthemes::theme_unhcr(
      font_size = 14,
      grid = FALSE,
      axis = FALSE
    ) +
    ggplot2::theme(
      legend.key.width = ggplot2::unit(2, "cm"),
      legend.key.height = ggplot2::unit(0.5, "cm"),
      legend.text = ggplot2::element_text(size = 10),
      axis.text = ggplot2::element_blank(),
      axis.title = ggplot2::element_blank(),
      panel.grid = ggplot2::element_blank()
    )

  return(p)
}
